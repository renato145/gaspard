<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Gaspard’s source – gaspard</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-92ed5e3cbc5d145d6df6ed0eb00c1a90.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Gaspard’s source – gaspard">
<meta property="og:description" content="Helper for Gemini API">
<meta property="og:image" content="https://AnswerDotAI.github.io/gaspard/00_core_files/figure-html/cell-141-output-1.jpeg">
<meta property="og:site_name" content="gaspard">
<meta name="twitter:title" content="Gaspard’s source – gaspard">
<meta name="twitter:description" content="Helper for Gemini API">
<meta name="twitter:image" content="https://AnswerDotAI.github.io/gaspard/00_core_files/figure-html/cell-141-output-1.jpeg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">gaspard</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">Gaspard’s source</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaspard</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Gaspard’s source</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_toolloop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tool loop</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#gemini-sdk" id="toc-gemini-sdk" class="nav-link" data-scroll-target="#gemini-sdk">Gemini SDK</a></li>
  <li><a href="#formatting-output" id="toc-formatting-output" class="nav-link" data-scroll-target="#formatting-output">Formatting output</a>
  <ul class="collapse">
  <li><a href="#find_block" id="toc-find_block" class="nav-link" data-scroll-target="#find_block">find_block</a></li>
  <li><a href="#contents" id="toc-contents" class="nav-link" data-scroll-target="#contents">contents</a></li>
  <li><a href="#usage" id="toc-usage" class="nav-link" data-scroll-target="#usage">usage</a></li>
  <li><a href="#usagemetadata.total" id="toc-usagemetadata.total" class="nav-link" data-scroll-target="#usagemetadata.total">UsageMetadata.total</a></li>
  <li><a href="#usagemetadata.__repr__" id="toc-usagemetadata.__repr__" class="nav-link" data-scroll-target="#usagemetadata.__repr__">UsageMetadata.__repr__</a></li>
  <li><a href="#usagemetadata.__add__" id="toc-usagemetadata.__add__" class="nav-link" data-scroll-target="#usagemetadata.__add__">UsageMetadata.__add__</a></li>
  </ul></li>
  <li><a href="#creating-messages" id="toc-creating-messages" class="nav-link" data-scroll-target="#creating-messages">Creating messages</a>
  <ul class="collapse">
  <li><a href="#mk_msgs" id="toc-mk_msgs" class="nav-link" data-scroll-target="#mk_msgs">mk_msgs</a></li>
  </ul></li>
  <li><a href="#client" id="toc-client" class="nav-link" data-scroll-target="#client">Client</a>
  <ul class="collapse">
  <li><a href="#client-1" id="toc-client-1" class="nav-link" data-scroll-target="#client-1">Client</a></li>
  <li><a href="#get_stream" id="toc-get_stream" class="nav-link" data-scroll-target="#get_stream">get_stream</a></li>
  <li><a href="#client.__call__" id="toc-client.__call__" class="nav-link" data-scroll-target="#client.__call__">Client.__call__</a></li>
  <li><a href="#get_pricing" id="toc-get_pricing" class="nav-link" data-scroll-target="#get_pricing">get_pricing</a></li>
  <li><a href="#client.cost" id="toc-client.cost" class="nav-link" data-scroll-target="#client.cost">Client.cost</a></li>
  </ul></li>
  <li><a href="#tool-use" id="toc-tool-use" class="nav-link" data-scroll-target="#tool-use">Tool Use</a>
  <ul class="collapse">
  <li><a href="#contents-1" id="toc-contents-1" class="nav-link" data-scroll-target="#contents-1">contents</a></li>
  <li><a href="#convert_func" id="toc-convert_func" class="nav-link" data-scroll-target="#convert_func">convert_func</a></li>
  <li><a href="#mk_toolres" id="toc-mk_toolres" class="nav-link" data-scroll-target="#mk_toolres">mk_toolres</a></li>
  <li><a href="#mk_msgs-1" id="toc-mk_msgs-1" class="nav-link" data-scroll-target="#mk_msgs-1">mk_msgs</a></li>
  </ul></li>
  <li><a href="#structured-outputs" id="toc-structured-outputs" class="nav-link" data-scroll-target="#structured-outputs">Structured Outputs</a>
  <ul class="collapse">
  <li><a href="#json2proto" id="toc-json2proto" class="nav-link" data-scroll-target="#json2proto">json2proto</a></li>
  <li><a href="#cls2tool" id="toc-cls2tool" class="nav-link" data-scroll-target="#cls2tool">cls2tool</a></li>
  <li><a href="#mk_args" id="toc-mk_args" class="nav-link" data-scroll-target="#mk_args">mk_args</a></li>
  <li><a href="#mk_tool_config" id="toc-mk_tool_config" class="nav-link" data-scroll-target="#mk_tool_config">mk_tool_config</a></li>
  <li><a href="#client.structured" id="toc-client.structured" class="nav-link" data-scroll-target="#client.structured">Client.structured</a></li>
  </ul></li>
  <li><a href="#chat" id="toc-chat" class="nav-link" data-scroll-target="#chat">Chat</a>
  <ul class="collapse">
  <li><a href="#chat-1" id="toc-chat-1" class="nav-link" data-scroll-target="#chat-1">Chat</a></li>
  <li><a href="#chat.__call__" id="toc-chat.__call__" class="nav-link" data-scroll-target="#chat.__call__">Chat.__call__</a></li>
  </ul></li>
  <li><a href="#images" id="toc-images" class="nav-link" data-scroll-target="#images">Images</a>
  <ul class="collapse">
  <li><a href="#media_msg" id="toc-media_msg" class="nav-link" data-scroll-target="#media_msg">media_msg</a></li>
  <li><a href="#text_msg" id="toc-text_msg" class="nav-link" data-scroll-target="#text_msg">text_msg</a></li>
  <li><a href="#mk_msg" id="toc-mk_msg" class="nav-link" data-scroll-target="#mk_msg">mk_msg</a></li>
  <li><a href="#mk_msgs-2" id="toc-mk_msgs-2" class="nav-link" data-scroll-target="#mk_msgs-2">mk_msgs</a></li>
  </ul></li>
  <li><a href="#other-media-audio-video-etc." id="toc-other-media-audio-video-etc." class="nav-link" data-scroll-target="#other-media-audio-video-etc.">Other Media (audio, video, etc.)</a>
  <ul class="collapse">
  <li><a href="#media_msg-1" id="toc-media_msg-1" class="nav-link" data-scroll-target="#media_msg-1">media_msg</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/AnswerDotAI/gaspard/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="core.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Gaspard’s source</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div id="e837ab99" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> (<span class="st">'gemini-2.0-flash-exp'</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">'gemini-exp-1206'</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">'learnlm-1.5-pro-experimental'</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">'gemini-exp-1121'</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">'gemini-1.5-pro'</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">'gemini-1.5-flash'</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">'gemini-1.5-flash-8b'</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>         )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>These are the latest version of Gemini models available at the time of writing.</p>
<div id="d3c81236" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> models[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll use the new gemini-2.0-flash for the examples since it’s awesome, faster and cheaper.</p>
</section>
<section id="gemini-sdk" class="level2">
<h2 class="anchored" data-anchor-id="gemini-sdk">Gemini SDK</h2>
<p>Follow the <a href="https://aistudio.google.com/app/apikey">instructions</a> to generate an API key, and set it as an evironment variable.</p>
<div id="f4a4919f" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>genai.configure(api_key<span class="op">=</span>os.environ[<span class="st">"GEMINI_API_KEY"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="338b89fa" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cli <span class="op">=</span> genai.GenerativeModel(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cd62f521" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> cli.generate_content(<span class="st">"Hi, I'm Faisal!"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Faisal! It’s nice to meet you. I’m an AI, and I’m here to help. What can I do for you today?</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: “Hi Faisal! It’s nice to meet you. I’m an AI, and I’m here to help. What can I do for you today?”}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.23590449725880341</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 8</li>
<li>candidates_token_count: 34</li>
<li>total_token_count: 42</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
</section>
<section id="formatting-output" class="level2">
<h2 class="anchored" data-anchor-id="formatting-output">Formatting output</h2>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L43" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="find_block" class="level3">
<h3 class="anchored" data-anchor-id="find_block">find_block</h3>
<blockquote class="blockquote">
<pre><code> find_block (r:collections.abc.Mapping)</code></pre>
</blockquote>
<p><em>Find the content in <code>r</code>.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>r</td>
<td>Mapping</td>
<td>The message to look in</td>
</tr>
</tbody>
</table>
<div id="97739d6e" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_block(r:abc.Mapping, <span class="co"># The message to look in</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>              ):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Find the content in `r`."</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> nested_idx(r, <span class="st">'candidates'</span>, <span class="dv">0</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> m: <span class="cf">return</span> m</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(m, <span class="st">'content'</span>): <span class="cf">return</span> m.content </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="cf">return</span> m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cf1b4144" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>find_block(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>parts {
  text: "Hi Faisal! It\'s nice to meet you. I\'m an AI, and I\'m here to help. What can I do for you today?\n"
}
role: "model"</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L193" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="contents" class="level3">
<h3 class="anchored" data-anchor-id="contents">contents</h3>
<blockquote class="blockquote">
<pre><code> contents (r)</code></pre>
</blockquote>
<p><em>Helper to get the contents from response <code>r</code>.</em></p>
<div id="548f0dd4" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> contents(r):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to get the contents from response `r`."</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    blk <span class="op">=</span> find_block(r)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> blk: <span class="cf">return</span> r</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(blk, <span class="st">'parts'</span>): <span class="cf">return</span> <span class="bu">getattr</span>(blk,<span class="st">'parts'</span>)[<span class="dv">0</span>].text</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> blk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="7a0d7340" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>contents(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>"Hi Faisal! It's nice to meet you. I'm an AI, and I'm here to help. What can I do for you today?\n"</code></pre>
</div>
</div>
<div id="9d37d39e" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _repr_markdown_(<span class="va">self</span>:GenerateContentResponse):</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    met <span class="op">=</span> <span class="bu">list</span>(<span class="va">self</span>.to_dict()[<span class="st">'candidates'</span>][<span class="dv">0</span>].items()) <span class="op">+</span> <span class="bu">list</span>(<span class="va">self</span>.to_dict()[<span class="st">'usage_metadata'</span>].items())</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    det <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">- '</span>.join(<span class="ss">f'</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> k,v <span class="kw">in</span> met)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> contents(<span class="va">self</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> res: <span class="cf">return</span> <span class="ss">f"- </span><span class="sc">{</span>det<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""</span><span class="sc">{</span>contents(<span class="va">self</span>)<span class="sc">}</span><span class="ch">\n</span><span class="ss">&lt;details&gt;</span><span class="ch">\n\n</span><span class="ss">- </span><span class="sc">{</span>det<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">&lt;/details&gt;"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cbf3a3a5" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Faisal! It’s nice to meet you. I’m an AI, and I’m here to help. What can I do for you today?</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: “Hi Faisal! It’s nice to meet you. I’m an AI, and I’m here to help. What can I do for you today?”}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.23590449725880341</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 8</li>
<li>candidates_token_count: 34</li>
<li>total_token_count: 42</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<div id="eb3b541b" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>r.usage_metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 8; Out: 34; Total: 42</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L69" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage" class="level3">
<h3 class="anchored" data-anchor-id="usage">usage</h3>
<blockquote class="blockquote">
<pre><code> usage (inp=0, out=0)</code></pre>
</blockquote>
<p><em>Slightly more concise version of <code>Usage</code>.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>inp</td>
<td>int</td>
<td>0</td>
<td>Number of input tokens</td>
</tr>
<tr class="even">
<td>out</td>
<td>int</td>
<td>0</td>
<td>Number of output tokens</td>
</tr>
</tbody>
</table>
<div id="61918cfd" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> usage(inp<span class="op">=</span><span class="dv">0</span>, <span class="co"># Number of input tokens</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>          out<span class="op">=</span><span class="dv">0</span>  <span class="co"># Number of output tokens</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>         ):</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Slightly more concise version of `Usage`."</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> UsageMetadata(prompt_token_count<span class="op">=</span>inp, candidates_token_count<span class="op">=</span>out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="c443d1e5" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>usage(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 5; Out: 0; Total: 5</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L77" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usagemetadata.total" class="level3">
<h3 class="anchored" data-anchor-id="usagemetadata.total">UsageMetadata.total</h3>
<blockquote class="blockquote">
<pre><code> UsageMetadata.total ()</code></pre>
</blockquote>
<div id="fb30b16f" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(as_prop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> total(<span class="va">self</span>:UsageMetadata): <span class="cf">return</span> <span class="va">self</span>.prompt_token_count<span class="op">+</span><span class="va">self</span>.candidates_token_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L81" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usagemetadata.__repr__" class="level3">
<h3 class="anchored" data-anchor-id="usagemetadata.__repr__">UsageMetadata.__repr__</h3>
<blockquote class="blockquote">
<pre><code> UsageMetadata.__repr__ ()</code></pre>
</blockquote>
<p><em>Return repr(self).</em></p>
<div id="1b99e8ba" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>:UsageMetadata): <span class="cf">return</span> <span class="ss">f'In: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>prompt_token_count<span class="sc">}</span><span class="ss">; Out: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>candidates_token_count<span class="sc">}</span><span class="ss">; Total: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>total<span class="sc">}</span><span class="ss">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="b6780c5d" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>r.usage_metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 8; Out: 34; Total: 42</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L85" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usagemetadata.__add__" class="level3">
<h3 class="anchored" data-anchor-id="usagemetadata.__add__">UsageMetadata.__add__</h3>
<blockquote class="blockquote">
<pre><code> UsageMetadata.__add__ (b)</code></pre>
</blockquote>
<p><em>Add together each of <code>input_tokens</code> and <code>output_tokens</code></em></p>
<div id="d9fafcef" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>:UsageMetadata, b):</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add together each of `input_tokens` and `output_tokens`"</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> usage(<span class="va">self</span>.prompt_token_count<span class="op">+</span>b.prompt_token_count, <span class="va">self</span>.candidates_token_count<span class="op">+</span>b.candidates_token_count)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fa94215b" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>r.usage_metadata<span class="op">+</span>r.usage_metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 16; Out: 68; Total: 84</code></pre>
</div>
</div>
</section>
</section>
<section id="creating-messages" class="level2">
<h2 class="anchored" data-anchor-id="creating-messages">Creating messages</h2>
<div id="1cbe271c" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msg(content, role<span class="op">=</span><span class="st">'user'</span>, <span class="op">**</span>kw):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(content, GenerateContentResponse):</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>        blk <span class="op">=</span> find_block(content)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        role <span class="op">=</span> blk.role</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> blk.parts[<span class="dv">0</span>].text</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(content, <span class="bu">list</span>): content<span class="op">=</span>[content]</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(role<span class="op">=</span>role, parts<span class="op">=</span>content, <span class="op">**</span>kw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6924dece" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"I'm Faisal"</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> mk_msg(prompt)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'role': 'user', 'parts': ["I'm Faisal"]}</code></pre>
</div>
</div>
<div id="b2c4724e" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> cli.generate_content([m], generation_config<span class="op">=</span>GenerationConfig(max_output_tokens<span class="op">=</span><span class="dv">100</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Faisal, it’s nice to meet you! Is there anything I can help you with today?</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: “Hi Faisal, it’s nice to meet you! Is there anything I can help you with today?”}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.17574180256236682</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 5</li>
<li>candidates_token_count: 22</li>
<li>total_token_count: 27</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<div id="44ede3ba" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> [mk_msg(prompt), mk_msg(r), mk_msg(<span class="st">'I forgot my name. Can you remind me please?'</span>)]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'parts': ["I'm Faisal"]},
 {'role': 'model',
  'parts': ["Hi Faisal, it's nice to meet you! Is there anything I can help you with today?\n"]},
 {'role': 'user', 'parts': ['I forgot my name. Can you remind me please?']}]</code></pre>
</div>
</div>
<div id="f708fc4c" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>cli.generate_content(msgs, generation_config<span class="op">=</span>GenerationConfig(max_output_tokens<span class="op">=</span><span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Okay, Faisal, I can help with that! You just told me your name is <strong>Faisal</strong>. Don’t worry, it happens to everyone sometimes! Is there anything else I can help you with?</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: “Okay, Faisal, I can help with that! You just told me your name is <strong>Faisal</strong>. Don’t worry, it happens to everyone sometimes! Is there anything else I can help you with?”}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.27289701062579486</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 40</li>
<li>candidates_token_count: 43</li>
<li>total_token_count: 83</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>Let’s make this a bit easier.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L396" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="mk_msgs" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs">mk_msgs</h3>
<blockquote class="blockquote">
<pre><code> mk_msgs (msgs:list, **kw)</code></pre>
</blockquote>
<p><em>Helper to set ‘assistant’ role on alternate messages.</em></p>
<div id="f08352a2" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msgs(msgs:<span class="bu">list</span>, <span class="op">**</span>kw):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to set 'assistant' role on alternate messages."</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(msgs,<span class="bu">str</span>): msgs<span class="op">=</span>[msgs]</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [mk_msg(o, (<span class="st">'user'</span>,<span class="st">'model'</span>)[i<span class="op">%</span><span class="dv">2</span>], <span class="op">**</span>kw) <span class="cf">for</span> i,o <span class="kw">in</span> <span class="bu">enumerate</span>(msgs)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="2b27ee82" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([<span class="st">"Hi, I'm Faisal!"</span>, r, <span class="st">"I forgot my name. Can you remind me please?"</span>])<span class="op">;</span> msgs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'parts': ["Hi, I'm Faisal!"]},
 {'role': 'model',
  'parts': ["Hi Faisal, it's nice to meet you! Is there anything I can help you with today?\n"]},
 {'role': 'user', 'parts': ['I forgot my name. Can you remind me please?']}]</code></pre>
</div>
</div>
<div id="98dcb0f6" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>cli.generate_content(msgs, generation_config<span class="op">=</span>GenerationConfig(max_output_tokens<span class="op">=</span><span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Of course! Your name is Faisal. 😊</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘Of course! Your name is Faisal. 😊’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.5640183448791504</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 43</li>
<li>candidates_token_count: 10</li>
<li>total_token_count: 53</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="client" class="level2">
<h2 class="anchored" data-anchor-id="client">Client</h2>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L96" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="client-1" class="level3">
<h3 class="anchored" data-anchor-id="client-1">Client</h3>
<blockquote class="blockquote">
<pre><code> Client (model, cli=None, sp=None)</code></pre>
</blockquote>
<p><em>Basic LLM messages client.</em></p>
<div id="05864cf8" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Client:</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, cli<span class="op">=</span><span class="va">None</span>, sp<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Basic LLM messages client."</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model,<span class="va">self</span>.use <span class="op">=</span> model,usage(<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sp <span class="op">=</span> sp</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.c <span class="op">=</span> (cli <span class="kw">or</span> genai.GenerativeModel(model, system_instruction<span class="op">=</span>sp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="0db82494" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Client(model)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 0; Out: 0; Total: 0</code></pre>
</div>
</div>
<div id="198eac02" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _r(<span class="va">self</span>:Client, r:GenerateContentResponse):</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Store the result of the message and accrue total usage."</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.result <span class="op">=</span> r</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">getattr</span>(r,<span class="st">'usage_metadata'</span>,<span class="va">None</span>): <span class="va">self</span>.use <span class="op">+=</span> r.usage_metadata</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="dea8466e" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>c._r(r)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 5; Out: 22; Total: 27</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L112" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_stream" class="level3">
<h3 class="anchored" data-anchor-id="get_stream">get_stream</h3>
<blockquote class="blockquote">
<pre><code> get_stream (r)</code></pre>
</blockquote>
<p>Gemini cli requires passing the system prompt when creating the client, so we recreate the client for now.</p>
<p>TODO: Ask Google to surface this option to generate_content function, since they’re passing the system prompt to each request anyways <a href="https://github.com/googleapis/python-aiplatform/blob/f89df1f30822d260176487f74c3743cab88a38fd/vertexai/generative_models/_generative_models.py#L446">under the hood</a>.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L134" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="client.__call__" class="level3">
<h3 class="anchored" data-anchor-id="client.__call__">Client.__call__</h3>
<blockquote class="blockquote">
<pre><code> Client.__call__ (msgs:list, sp:str=None, maxtok=4096, stream:bool=False,
                  generation_config:generation_types.GenerationConfigType|
                  None=None, safety_settings:safety_types.SafetySettingOpt
                  ions|None=None,
                  tools:content_types.FunctionLibraryType|None=None,
                  tool_config:content_types.ToolConfigType|None=None, requ
                  est_options:helper_types.RequestOptionsType|None=None)</code></pre>
</blockquote>
<p><em>Make a call to LLM.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>msgs</td>
<td>list</td>
<td></td>
<td>List of messages in the dialog</td>
</tr>
<tr class="even">
<td>sp</td>
<td>str</td>
<td>None</td>
<td>System prompt</td>
</tr>
<tr class="odd">
<td>maxtok</td>
<td>int</td>
<td>4096</td>
<td>Maximum tokens</td>
</tr>
<tr class="even">
<td>stream</td>
<td>bool</td>
<td>False</td>
<td>Stream response?</td>
</tr>
<tr class="odd">
<td>generation_config</td>
<td>generation_types.GenerationConfigType | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>safety_settings</td>
<td>safety_types.SafetySettingOptions | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>tools</td>
<td>content_types.FunctionLibraryType | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>tool_config</td>
<td>content_types.ToolConfigType | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>request_options</td>
<td>helper_types.RequestOptionsType | None</td>
<td>None</td>
<td></td>
</tr>
</tbody>
</table>
<div id="2ba14a0b" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _precall(<span class="va">self</span>:Client, msgs):</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(msgs,<span class="bu">list</span>): msgs <span class="op">=</span> [msgs]</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    msgs <span class="op">=</span> mk_msgs(msgs)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> msgs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="06bac993" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(genai.GenerativeModel.generate_content)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>:Client,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>             msgs:<span class="bu">list</span>, <span class="co"># List of messages in the dialog</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>             sp:<span class="bu">str</span><span class="op">=</span><span class="va">None</span>, <span class="co"># System prompt</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>             maxtok<span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>             stream:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>             <span class="op">**</span>kwargs):</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Make a call to LLM."</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sp: <span class="va">self</span>._set_sp(sp)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    msgs <span class="op">=</span> <span class="va">self</span>._precall(msgs)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    gc_params <span class="op">=</span> inspect.signature(GenerationConfig.<span class="fu">__init__</span>).parameters</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    gc_kwargs <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> kwargs.items() <span class="cf">if</span> k <span class="kw">in</span> gc_params}</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    gen_config <span class="op">=</span> GenerationConfig(max_output_tokens<span class="op">=</span>maxtok, <span class="op">**</span>gc_kwargs)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    gen_params <span class="op">=</span> inspect.signature(<span class="va">self</span>.c.generate_content).parameters</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    gen_kwargs <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> kwargs.items() <span class="cf">if</span> k <span class="kw">in</span> gen_params}</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> <span class="va">self</span>.c.generate_content(</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>        contents<span class="op">=</span>msgs, generation_config<span class="op">=</span>gen_config, stream<span class="op">=</span>stream, <span class="op">**</span>gen_kwargs)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> stream: <span class="cf">return</span> <span class="va">self</span>._r(r)</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="cf">return</span> get_stream(<span class="bu">map</span>(<span class="va">self</span>._r, r))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="d060f1b8" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>c.c.generate_content(<span class="st">'hi'</span>).text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'Hi there! How can I help you today?\n'</code></pre>
</div>
</div>
<div id="3850ec42" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> [<span class="st">'hi'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d50775d1" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>c(msgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi there! How can I help you today?</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘Hi there! How can I help you today?’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.017421615394678982</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 2</li>
<li>candidates_token_count: 11</li>
<li>total_token_count: 13</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<div id="c9bb4ba3" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 7; Out: 33; Total: 40</code></pre>
</div>
</div>
<div id="97727a4b" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> c(msgs, stream<span class="op">=</span><span class="va">True</span>): <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hi there! How can I help you today?</code></pre>
</div>
</div>
<div id="9d37358f" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 11; Out: 44; Total: 55</code></pre>
</div>
</div>
<p>Gemini cli requires passing the system prompt when creating the client, but we didn’t pass one at creation time. Let’s make sure that it gets set properly when we call the client later.</p>
<div id="0450fe01" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>sysp <span class="op">=</span> <span class="st">"Respond only in emojis"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b0a978d5" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>c(msgs, sp<span class="op">=</span>sysp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>👋</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘👋’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.00037874732515774667</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 6</li>
<li>candidates_token_count: 2</li>
<li>total_token_count: 8</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>We’ve shown the token usage but we really care about is pricing. Let’s extract the latest <a href="https://ai.google.dev/pricing#1_5pro">pricing</a> from Google into a pricing dict. Currently, the experimental version Gemini 2.0 Flash is free, and the pricing of other experimental models is not entirely clear. Since there’s rumors they are two experimental version of the upcoming Gemini 2.0 Pro, they are priced as 1.5 Pro. Better safe than sorry.</p>
<div id="5d1c5a0e" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>pricing <span class="op">=</span> {  <span class="co"># model type: $ / million tokens (input, output, cache, input_long, output_long, cache_long)</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gemini-2.0-flash-exp'</span>: (<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gemini-1.5-pro'</span>: (<span class="fl">1.25</span>, <span class="fl">5.0</span>, <span class="fl">0.3125</span>, <span class="fl">2.50</span>, <span class="fl">10.0</span>, <span class="fl">0.625</span>),</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gemini-1.5-flash'</span>: (<span class="fl">0.075</span>, <span class="fl">0.30</span>, <span class="fl">0.01875</span>, <span class="fl">0.15</span>, <span class="fl">0.60</span>, <span class="fl">0.0375</span>),</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gemini-exp-1206'</span>: (<span class="fl">1.25</span>, <span class="fl">5.0</span>, <span class="fl">0.3125</span>, <span class="fl">2.50</span>, <span class="fl">10.0</span>, <span class="fl">0.625</span>),</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gemini-exp-1121'</span>: (<span class="fl">1.25</span>, <span class="fl">5.0</span>, <span class="fl">0.3125</span>, <span class="fl">2.50</span>, <span class="fl">10.0</span>, <span class="fl">0.625</span>),</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'learnlm-1.5-pro-experimental'</span>: (<span class="fl">1.25</span>, <span class="fl">5.0</span>, <span class="fl">0.3125</span>, <span class="fl">2.50</span>, <span class="fl">10.0</span>, <span class="fl">0.625</span>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now let’s add a cost prop to <a href="https://AnswerDotAI.github.io/gaspard/core.html#client"><code>Client</code></a> to calculate the total cost.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L165" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_pricing" class="level3">
<h3 class="anchored" data-anchor-id="get_pricing">get_pricing</h3>
<blockquote class="blockquote">
<pre><code> get_pricing (m, u)</code></pre>
</blockquote>
<div id="1450d492" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_pricing(m, u):</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pricing[m][:<span class="dv">3</span>] <span class="cf">if</span> u.prompt_token_count <span class="op">&lt;</span> <span class="dv">128_000</span> <span class="cf">else</span> pricing[m][<span class="dv">3</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L170" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="client.cost" class="level3">
<h3 class="anchored" data-anchor-id="client.cost">Client.cost</h3>
<blockquote class="blockquote">
<pre><code> Client.cost ()</code></pre>
</blockquote>
<div id="c694a305" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(as_prop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(<span class="va">self</span>:Client):</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    inp_cost, out_cost, cache_cost <span class="op">=</span> get_pricing(<span class="va">self</span>.model.split(<span class="st">'-exp-'</span>)[<span class="dv">0</span>], <span class="va">self</span>.use)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="va">self</span>.use.prompt_token_count <span class="op">*</span> inp_cost <span class="op">+</span> <span class="va">self</span>.use.candidates_token_count <span class="op">*</span> out_cost <span class="op">+</span> <span class="va">self</span>.use.cached_content_token_count <span class="op">*</span> cache_cost) <span class="op">/</span> <span class="fl">1e6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="d6a48912" class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>c.cost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.0</code></pre>
</div>
</div>
<div id="0293e239" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _repr_markdown_(<span class="va">self</span>:Client):</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>,<span class="st">'result'</span>): <span class="cf">return</span> <span class="st">'No results yet'</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    msg <span class="op">=</span> contents(<span class="va">self</span>.result)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    inp_cost,out_cost,_ <span class="op">=</span> get_pricing(<span class="va">self</span>.model.split(<span class="st">'-exp-'</span>)[<span class="dv">0</span>], <span class="va">self</span>.use)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    in_cost <span class="op">=</span> <span class="va">self</span>.use.prompt_token_count <span class="op">*</span> inp_cost<span class="op">/</span><span class="fl">1e6</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    out_cost <span class="op">=</span> <span class="va">self</span>.use.candidates_token_count <span class="op">*</span> out_cost<span class="op">/</span><span class="fl">1e6</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    cache_cost <span class="op">=</span> <span class="va">self</span>.use.cached_content_token_count <span class="op">*</span> out_cost<span class="op">/</span><span class="fl">1e6</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""</span><span class="sc">{</span>msg<span class="sc">}</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="ss">| Metric | Count | Cost (USD) |</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="ss">|--------|------:|-----:|</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="ss">| Input tokens | </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>use<span class="sc">.</span>prompt_token_count<span class="sc">:,}</span><span class="ss"> | </span><span class="sc">{</span>in_cost<span class="sc">:.6f}</span><span class="ss"> |</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="ss">| Output tokens | </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>use<span class="sc">.</span>candidates_token_count<span class="sc">:,}</span><span class="ss"> | </span><span class="sc">{</span>out_cost<span class="sc">:.6f}</span><span class="ss"> |</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="ss">| Cache tokens | </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>use<span class="sc">.</span>cached_content_token_count<span class="sc">:,}</span><span class="ss"> | </span><span class="sc">{</span>cache_cost<span class="sc">:.6f}</span><span class="ss"> |</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a><span class="ss">| **Total** | **</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>use<span class="sc">.</span>total<span class="sc">:,}</span><span class="ss">** | **$</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>cost<span class="sc">:.6f}</span><span class="ss">** |"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="c8304456" class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>👋</p>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th>Metric</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Cost (USD)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input tokens</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td>Output tokens</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="odd">
<td>Cache tokens</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td><strong>Total</strong></td>
<td style="text-align: right;"><strong>63</strong></td>
<td style="text-align: right;"><strong>$0.000000</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="tool-use" class="level2">
<h2 class="anchored" data-anchor-id="tool-use">Tool Use</h2>
<div id="008d7d8d" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sums(</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    a:<span class="bu">int</span>,  <span class="co"># First thing to sum</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    b:<span class="bu">int</span> <span class="co"># Second thing to sum</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>: <span class="co"># The sum of the inputs</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Adds a + b."</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Finding the sum of </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bb24d113" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>sysp <span class="op">=</span> <span class="st">"You are a helpful assistant. When using tools, be sure to pass all required parameters, at minimum."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3c7b4cd3" class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>a,b <span class="op">=</span> <span class="dv">604542</span>,<span class="dv">6458932</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="ss">f"What is </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">+</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">?"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Google’s Genai API handles schema exatraction under the hood, so we can just directly pass the functions</p>
<div id="0f714d21" class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(pr, sp<span class="op">=</span>sysp, tools<span class="op">=</span>[sums])</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<ul>
<li>content: {‘parts’: [{‘function_call’: {‘name’: ‘sums’, ‘args’: {‘a’: 604542.0, ‘b’: 6458932.0}}}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -5.444032770659153e-06</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 86</li>
<li>candidates_token_count: 3</li>
<li>total_token_count: 89</li>
<li>cached_content_token_count: 0</li>
</ul>
</div>
</div>
<p>Looks like our output isn’t pretty anymore. Let’s fix that</p>
<div id="5dbc5048" class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>contents(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>''</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L193" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="contents-1" class="level3">
<h3 class="anchored" data-anchor-id="contents-1">contents</h3>
<blockquote class="blockquote">
<pre><code> contents (r)</code></pre>
</blockquote>
<p><em>Helper to get the contents from response <code>r</code>.</em></p>
<div id="b945925a" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> contents(r):</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to get the contents from response `r`."</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    blk <span class="op">=</span> find_block(r)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> blk: <span class="cf">return</span> r</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(blk, <span class="st">'parts'</span>):</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        part <span class="op">=</span> blk.parts[<span class="dv">0</span>]</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'text'</span> <span class="kw">in</span> part:</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> part.text</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> part</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> blk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="7d509ae7" class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>contents(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>function_call {
  name: "sums"
  args {
    fields {
      key: "b"
      value {
        number_value: 6458932
      }
    }
    fields {
      key: "a"
      value {
        number_value: 604542
      }
    }
  }
}</code></pre>
</div>
</div>
<div id="7a2a9585" class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>function_call { name: “sums” args { fields { key: “b” value { number_value: 6458932 } } fields { key: “a” value { number_value: 604542 } } } }</p>
<details>
<ul>
<li>content: {‘parts’: [{‘function_call’: {‘name’: ‘sums’, ‘args’: {‘a’: 604542.0, ‘b’: 6458932.0}}}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -5.444032770659153e-06</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 86</li>
<li>candidates_token_count: 3</li>
<li>total_token_count: 89</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>B-e-a-utiful…</p>
<div id="9441a121" class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> find_block(r)<span class="op">;</span> m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>parts {
  function_call {
    name: "sums"
    args {
      fields {
        key: "b"
        value {
          number_value: 6458932
        }
      }
      fields {
        key: "a"
        value {
          number_value: 604542
        }
      }
    }
  }
}
role: "model"</code></pre>
</div>
</div>
<div id="752e621d" class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>func <span class="op">=</span> m.parts[<span class="dv">0</span>].function_call<span class="op">;</span> func</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>name: "sums"
args {
  fields {
    key: "b"
    value {
      number_value: 6458932
    }
  }
  fields {
    key: "a"
    value {
      number_value: 604542
    }
  }
}</code></pre>
</div>
</div>
<p>Let’s get the returned function call into a format that is expected by <code>call_func</code>.</p>
<div id="7179796d" class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k,v <span class="kw">in</span> func.args.items(): <span class="bu">print</span>(k, v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>a 604542.0
b 6458932.0</code></pre>
</div>
</div>
<div id="e36851c6" class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_args(args): <span class="cf">return</span> {k: v <span class="cf">for</span> k,v <span class="kw">in</span> args.items()}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="dcb429a7" class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>mk_args(func.args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'a': 604542.0, 'b': 6458932.0}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L207" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="convert_func" class="level3">
<h3 class="anchored" data-anchor-id="convert_func">convert_func</h3>
<blockquote class="blockquote">
<pre><code> convert_func (f)</code></pre>
</blockquote>
<div id="7f0f66d0" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_func(f): <span class="cf">return</span> AttrDict(name<span class="op">=</span>f.name, inputs<span class="op">=</span>mk_args(f.args))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="977445b0" class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>func <span class="op">=</span> convert_func(func)<span class="op">;</span> func</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb99"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="er">'inputs'</span><span class="fu">:</span> <span class="fu">{</span><span class="er">'a'</span><span class="fu">:</span> <span class="fl">604542.0</span><span class="fu">,</span> <span class="er">'b'</span><span class="fu">:</span> <span class="fl">6458932.0</span><span class="fu">},</span> <span class="er">'name'</span><span class="fu">:</span> <span class="er">'sums'</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="e9127c59" class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>ns <span class="op">=</span> mk_ns(sums)<span class="op">;</span> ns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'sums': &lt;function __main__.sums(a: int, b: int) -&gt; int&gt;}</code></pre>
</div>
</div>
<div id="8d387b35" class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> call_func(func.name, func.inputs, ns)<span class="op">;</span> res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542.0 and 6458932.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>7063474.0</code></pre>
</div>
</div>
<div id="4eb08798" class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msg(content, role<span class="op">=</span><span class="st">'user'</span>, <span class="op">**</span>kw):</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(content, GenerateContentResponse): role,content <span class="op">=</span> <span class="st">'model'</span>,contents(content)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(content, <span class="bu">dict</span>): role,content <span class="op">=</span> content[<span class="st">'role'</span>],content[<span class="st">'parts'</span>]</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(content, <span class="bu">list</span>): content<span class="op">=</span>[content]</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(role<span class="op">=</span>role, parts<span class="op">=</span>content, <span class="op">**</span>kw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L210" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_toolres" class="level3">
<h3 class="anchored" data-anchor-id="mk_toolres">mk_toolres</h3>
<blockquote class="blockquote">
<pre><code> mk_toolres (r:collections.abc.Mapping, ns)</code></pre>
</blockquote>
<p><em>Create a <code>tool_result</code> message from response <code>r</code>.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>r</td>
<td>Mapping</td>
<td>Tool use request response</td>
</tr>
<tr class="even">
<td>ns</td>
<td></td>
<td>Namespace to search for tools</td>
</tr>
</tbody>
</table>
<div id="6b788a08" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_toolres(</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    r:abc.Mapping, <span class="co"># Tool use request response</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    ns, <span class="co"># Namespace to search for tools</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create a `tool_result` message from response `r`."</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> find_block(r).parts</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    tcs <span class="op">=</span> [p.function_call <span class="cf">for</span> p <span class="kw">in</span> parts <span class="cf">if</span> <span class="bu">hasattr</span>(p, <span class="st">'function_call'</span>)]</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> [mk_msg(r)]</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    tc_res <span class="op">=</span> []</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> func <span class="kw">in</span> (tcs <span class="kw">or</span> []):</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> func: <span class="cf">continue</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>        func <span class="op">=</span> convert_func(func)</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>        cts <span class="op">=</span> call_func(func.name, func.inputs, ns<span class="op">=</span>ns)</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>        tc_res.append(FunctionResponse(name<span class="op">=</span>func.name, response<span class="op">=</span>{<span class="st">'result'</span>: cts}))</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tc_res: res.append(mk_msg(tc_res))</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="9ec7457e" class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> mk_toolres(r, ns<span class="op">=</span>ns)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>tr[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542.0 and 6458932.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'role': 'user',
 'parts': [name: "sums"
  response {
    fields {
      key: "result"
      value {
        number_value: 7063474
      }
    }
  }]}</code></pre>
</div>
</div>
<div id="d609ed0a" class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> [pr] <span class="op">+</span> tr<span class="op">;</span> msgs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['What is 604542+6458932?',
 {'role': 'model', 'parts': [function_call {
     name: "sums"
     args {
       fields {
         key: "b"
         value {
           number_value: 6458932
         }
       }
       fields {
         key: "a"
         value {
           number_value: 604542
         }
       }
     }
   }]},
 {'role': 'user',
  'parts': [name: "sums"
   response {
     fields {
       key: "result"
       value {
         number_value: 7063474
       }
     }
   }]}]</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L396" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msgs-1" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs-1">mk_msgs</h3>
<blockquote class="blockquote">
<pre><code> mk_msgs (msgs:list, **kw)</code></pre>
</blockquote>
<p><em>Helper to set ‘assistant’ role on alternate messages.</em></p>
<div id="dee5aa0d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msgs(msgs:<span class="bu">list</span>, <span class="op">**</span>kw):</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to set 'assistant' role on alternate messages."</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(msgs,<span class="bu">str</span>): msgs<span class="op">=</span>[msgs]</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [mk_msg(o, (<span class="st">'user'</span>,<span class="st">'model'</span>)[i<span class="op">%</span><span class="dv">2</span>], <span class="op">**</span>kw) <span class="cf">for</span> i,o <span class="kw">in</span> <span class="bu">enumerate</span>(msgs)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="5e7848bf" class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>mk_msgs(msgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'parts': ['What is 604542+6458932?']},
 {'role': 'model',
  'parts': [function_call {
     name: "sums"
     args {
       fields {
         key: "b"
         value {
           number_value: 6458932
         }
       }
       fields {
         key: "a"
         value {
           number_value: 604542
         }
       }
     }
   }]},
 {'role': 'user',
  'parts': [name: "sums"
   response {
     fields {
       key: "result"
       value {
         number_value: 7063474
       }
     }
   }]}]</code></pre>
</div>
</div>
<div id="46a1a15d" class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> c(msgs, sp<span class="op">=</span>sysp, tools<span class="op">=</span>[sums])</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>7063474</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘7063474’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.09744896739721298</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 136</li>
<li>candidates_token_count: 8</li>
<li>total_token_count: 144</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>We can also force a particular set of tools to be used using, <code>tool_config</code>. Here’s an example of how to do that for genai api.</p>
<div id="bd1badc5" class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tool_config(choose: <span class="bu">list</span>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"function_calling_config"</span>: {<span class="st">"mode"</span>: <span class="st">"ANY"</span>, <span class="st">"allowed_function_names"</span>: [x.<span class="va">__name__</span> <span class="cf">for</span> x <span class="kw">in</span> choose]}}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a12dc557" class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>tool_config <span class="op">=</span> mk_tool_config([sums])<span class="op">;</span> tool_config</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'function_calling_config': {'mode': 'ANY',
  'allowed_function_names': ['sums']}}</code></pre>
</div>
</div>
<div id="6eba07ed" class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>c(<span class="st">'Howdy!'</span>, tools<span class="op">=</span>[sums], tool_config<span class="op">=</span>tool_config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>function_call { name: “sums” args { fields { key: “b” value { number_value: 2 } } fields { key: “a” value { number_value: 1 } } } }</p>
<details>
<ul>
<li>content: {‘parts’: [{‘function_call’: {‘name’: ‘sums’, ‘args’: {‘a’: 1.0, ‘b’: 2.0}}}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.00484422439088424</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 70</li>
<li>candidates_token_count: 3</li>
<li>total_token_count: 73</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="structured-outputs" class="level2">
<h2 class="anchored" data-anchor-id="structured-outputs">Structured Outputs</h2>
<p>We can also use tool calling to force the model to return structured outputs.</p>
<div id="ac6e3681" class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(Client.<span class="fu">__call__</span>)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> structured(<span class="va">self</span>:Client,</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>               msgs:<span class="bu">list</span>, <span class="co"># The prompt or list of prompts</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>               tools:<span class="bu">list</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>               <span class="op">**</span>kwargs):</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Return the value of all tool calls (generally used for structured outputs)"</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(msgs, <span class="bu">list</span>): msgs <span class="op">=</span> [msgs]</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(tools, <span class="bu">list</span>): tools <span class="op">=</span> [tools]</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    kwargs[<span class="st">'tools'</span>] <span class="op">=</span> tools</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>    kwargs[<span class="st">'tool_config'</span>] <span class="op">=</span> mk_tool_config(tools)</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> <span class="va">self</span>(msgs, <span class="op">**</span>kwargs)</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>    ns<span class="op">=</span>mk_ns(<span class="op">*</span>tools)</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> find_block(res).parts</span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>    funcs <span class="op">=</span> [convert_func(p.function_call) <span class="cf">for</span> p <span class="kw">in</span> parts <span class="cf">if</span> <span class="bu">hasattr</span>(p, <span class="st">'function_call'</span>)]</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>    tcs <span class="op">=</span> [call_func(func.name, func.inputs, ns<span class="op">=</span>ns) <span class="cf">for</span> func <span class="kw">in</span> funcs]</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tcs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f15813bf" class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Recipe(BasicRepr):</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"A structure for representing recipes."</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, recipe_name: <span class="bu">str</span>, ingredients: <span class="bu">list</span>[<span class="bu">str</span>]): store_attr()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Gemini API schema extraction doesn’t work very well for Class definitions so we define a factory method as a workaround.</p>
<div id="e7083831" class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">"Give me a receipe for chocolate chip cookies"</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>recipe <span class="op">=</span> c.structured(pr, tools<span class="op">=</span>[Recipe], sp<span class="op">=</span>sysp)[<span class="dv">0</span>]<span class="op">;</span> recipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Recipe(recipe_name='chocolate chip cookies', ingredients=['butter', 'sugar', 'egg', 'vanilla extract', 'flour', 'baking soda', 'salt', 'chocolate chips'])</code></pre>
</div>
</div>
<p>This works great, however, to handle to complex structured output usecases we need to manually create the schema objects to feed to the GenAI API.</p>
<div id="59bbecea" class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Turn(BasicRepr):</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Turn in the conversation"</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, msg_a: <span class="bu">str</span>, msg_b: <span class="bu">str</span>): store_attr()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3f27af89" class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Conversation(BasicRepr):</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"A conversation between two people"</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, turns: <span class="bu">list</span>[Turn]): store_attr()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s do this manually using GenAI’s special protobuf schema types.</p>
<div id="b8c95a62" class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>turn <span class="op">=</span> genai.protos.Schema(</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> <span class="op">=</span> genai.protos.Type.OBJECT,</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    properties <span class="op">=</span> {</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'msg_a'</span>:  genai.protos.Schema(<span class="bu">type</span><span class="op">=</span>genai.protos.Type.STRING),</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'msg_b'</span>:  genai.protos.Schema(<span class="bu">type</span><span class="op">=</span>genai.protos.Type.STRING),</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    required<span class="op">=</span>[<span class="st">'msg_a'</span>, <span class="st">'msg_b'</span>]</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="137ca8f0" class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>convo <span class="op">=</span> genai.protos.Schema(</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> <span class="op">=</span> genai.protos.Type.OBJECT,</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    properties <span class="op">=</span> {</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'turns'</span>:  genai.protos.Schema(<span class="bu">type</span><span class="op">=</span>genai.protos.Type.ARRAY, items<span class="op">=</span>turn)</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>    required<span class="op">=</span>[<span class="st">'turns'</span>]</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Great, now, let’s wrap this into the necessary function declaration that will then be used as a tool.</p>
<div id="11391714" class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>create_convo <span class="op">=</span> genai.protos.FunctionDeclaration(</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"create_convo"</span>,</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"Creates a conversation"</span>,</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>convo</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span> create_convo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>name: "create_convo"
description: "Creates a conversation"
parameters {
  type_: OBJECT
  properties {
    key: "turns"
    value {
      type_: ARRAY
      items {
        type_: OBJECT
        properties {
          key: "msg_b"
          value {
            type_: STRING
          }
        }
        properties {
          key: "msg_a"
          value {
            type_: STRING
          }
        }
        required: "msg_a"
        required: "msg_b"
      }
    }
  }
  required: "turns"
}</code></pre>
</div>
</div>
<div id="e52c157b" class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>gen_model <span class="op">=</span> genai.GenerativeModel(model_name<span class="op">=</span>model, tools <span class="op">=</span> [create_convo])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8c11c4a4" class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> gen_model.generate_content(pr, tool_config<span class="op">=</span>{<span class="st">'function_calling_config'</span>:<span class="st">'ANY'</span>})<span class="op">;</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>function_call { name: “create_convo” args { fields { key: “turns” value { list_value { values { struct_value { fields { key: “msg_b” value { string_value: “hi” } } fields { key: “msg_a” value { string_value: “hello” } } } } } } } } }</p>
<details>
<ul>
<li>content: {‘parts’: [{‘function_call’: {‘name’: ‘create_convo’, ‘args’: {‘turns’: [{‘msg_b’: ‘hi’, ‘msg_a’: ‘hello’}]}}}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.2613382706275353</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 109</li>
<li>candidates_token_count: 13</li>
<li>total_token_count: 122</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>Great, now let’s start by taking our normal JSON schema that we get from the helper function <code>get_schema</code> and converting it to a protobuf schema.</p>
<div id="00344ed0" class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>json_schema <span class="op">=</span> get_schema(Conversation)<span class="op">;</span> json_schema</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'name': 'Conversation',
 'description': 'A conversation between two people',
 'input_schema': {'type': 'object',
  'properties': {'turns': {'type': 'array',
    'description': '',
    'items': {'$ref': '#/$defs/Turn'}}},
  'title': 'Conversation',
  'required': ['turns'],
  '$defs': {'Turn': {'type': 'object',
    'properties': {'msg_a': {'type': 'string', 'description': ''},
     'msg_b': {'type': 'string', 'description': ''}},
    'title': 'Turn',
    'required': ['msg_a', 'msg_b']}}}}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L244" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="json2proto" class="level3">
<h3 class="anchored" data-anchor-id="json2proto">json2proto</h3>
<blockquote class="blockquote">
<pre><code> json2proto (schema_dict)</code></pre>
</blockquote>
<p><em>Convert JSON schema to protobuf schema</em></p>
<div id="227adccb" class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the Conversation schema</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>proto_schema <span class="op">=</span> json2proto(json_schema)<span class="op">;</span> proto_schema</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>type_: OBJECT
properties {
  key: "turns"
  value {
    type_: ARRAY
    items {
      type_: OBJECT
      properties {
        key: "msg_b"
        value {
          type_: STRING
        }
      }
      properties {
        key: "msg_a"
        value {
          type_: STRING
        }
      }
      required: "msg_a"
      required: "msg_b"
    }
  }
}
required: "turns"</code></pre>
</div>
</div>
<p>Let’s now make it into a proper tool.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L261" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="cls2tool" class="level3">
<h3 class="anchored" data-anchor-id="cls2tool">cls2tool</h3>
<blockquote class="blockquote">
<pre><code> cls2tool (c)</code></pre>
</blockquote>
<div id="cc56b482" class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>create_convo <span class="op">=</span> cls2tool(Conversation)<span class="op">;</span> create_convo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>name: "Conversation"
description: "A conversation between two people"
parameters {
  type_: OBJECT
  properties {
    key: "turns"
    value {
      type_: ARRAY
      items {
        type_: OBJECT
        properties {
          key: "msg_b"
          value {
            type_: STRING
          }
        }
        properties {
          key: "msg_a"
          value {
            type_: STRING
          }
        }
        required: "msg_a"
        required: "msg_b"
      }
    }
  }
  required: "turns"
}</code></pre>
</div>
</div>
<div id="f26648df" class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> gen_model.generate_content(pr, tool_config<span class="op">=</span>{<span class="st">'function_calling_config'</span>:<span class="st">'ANY'</span>})<span class="op">;</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>function_call { name: “create_convo” args { fields { key: “turns” value { list_value { values { struct_value { fields { key: “msg_b” value { string_value: “Okay, here is a recipe:\n\nIngredients:\n\n1 cup (2 sticks) unsalted butter, softened\n1 cup granulated sugar\n1 cup packed brown sugar\n2 teaspoons pure vanilla extract\n2 large eggs\n3 cups all-purpose flour\n1 teaspoon baking soda\n1 teaspoon salt\n2 cups chocolate chips\n\nInstructions\n\nPreheat oven to 375 degrees F (190 degrees C). Line baking sheets with parchment paper.\nIn a large bowl, cream together the butter, granulated sugar, and brown sugar until light and fluffy.\nBeat in the vanilla extract, then the eggs one at a time.\nIn a separate bowl, whisk together the flour, baking soda, and salt.\nGradually add the dry ingredients to the wet ingredients, mixing until just combined.\nStir in the chocolate chips.\nDrop by rounded tablespoons onto the prepared baking sheets.\nBake for 9-11 minutes, or until golden brown.Let cool on baking sheets for a few minutes before transferring to a wire rack to cool completely.” } } fields { key: “msg_a” value { string_value: “Hey, I'd love a chocolate chip cookie recipe.” } } } } } } } } }</p>
<details>
<ul>
<li>content: {‘parts’: [{‘function_call’: {‘name’: ‘create_convo’, ‘args’: {‘turns’: [{‘msg_b’: ‘Okay, here is a recipe:\n\nIngredients:\n\n1 cup (2 sticks) unsalted butter, softened\n1 cup granulated sugar\n1 cup packed brown sugar\n2 teaspoons pure vanilla extract\n2 large eggs\n3 cups all-purpose flour\n1 teaspoon baking soda\n1 teaspoon salt\n2 cups chocolate chips\n\nInstructions\n\nPreheat oven to 375 degrees F (190 degrees C). Line baking sheets with parchment paper.\nIn a large bowl, cream together the butter, granulated sugar, and brown sugar until light and fluffy.\nBeat in the vanilla extract, then the eggs one at a time.\nIn a separate bowl, whisk together the flour, baking soda, and salt.\nGradually add the dry ingredients to the wet ingredients, mixing until just combined.\nStir in the chocolate chips.\nDrop by rounded tablespoons onto the prepared baking sheets.\nBake for 9-11 minutes, or until golden brown.Let cool on baking sheets for a few minutes before transferring to a wire rack to cool completely.’, ‘msg_a’: “Hey, I’d love a chocolate chip cookie recipe.”}]}}}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>citation_metadata: {‘citation_sources’: [{‘start_index’: 925, ‘end_index’: 1046, ‘uri’: ‘https://dinneronceagain.com/tag/cooking/feed/’}]}</li>
<li>avg_logprobs: -0.09633702817170517</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 109</li>
<li>candidates_token_count: 253</li>
<li>total_token_count: 362</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<div id="e7afcb10" class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>func <span class="op">=</span> contents(result).function_call<span class="op">;</span> func</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>name: "create_convo"
args {
  fields {
    key: "turns"
    value {
      list_value {
        values {
          struct_value {
            fields {
              key: "msg_b"
              value {
                string_value: "Okay, here is a recipe:\\n\\nIngredients:\\n\\n1 cup (2 sticks) unsalted butter, softened\\n1 cup granulated sugar\\n1 cup packed brown sugar\\n2 teaspoons pure vanilla extract\\n2 large eggs\\n3 cups all-purpose flour\\n1 teaspoon baking soda\\n1 teaspoon salt\\n2 cups chocolate chips\\n\\nInstructions\\n\\nPreheat oven to 375 degrees F (190 degrees C). Line baking sheets with parchment paper.\\nIn a large bowl, cream together the butter, granulated sugar, and brown sugar until light and fluffy.\\nBeat in the vanilla extract, then the eggs one at a time.\\nIn a separate bowl, whisk together the flour, baking soda, and salt.\\nGradually add the dry ingredients to the wet ingredients, mixing until just combined.\\nStir in the chocolate chips.\\nDrop by rounded tablespoons onto the prepared baking sheets.\\nBake for 9-11 minutes, or until golden brown.Let cool on baking sheets for a few minutes before transferring to a wire rack to cool completely."
              }
            }
            fields {
              key: "msg_a"
              value {
                string_value: "Hey, I\'d love a chocolate chip cookie recipe."
              }
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div id="96499fee" class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>func.args</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;proto.marshal.collections.maps.MapComposite&gt;</code></pre>
</div>
</div>
<div id="656e017f" class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> mk_args(func.args)<span class="op">;</span> args</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'turns': [&lt;proto.marshal.collections.maps.MapComposite object&gt;]}</code></pre>
</div>
</div>
<p>Let’s update <a href="https://AnswerDotAI.github.io/gaspard/core.html#mk_args"><code>mk_args</code></a> to handle nested proto objects.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L279" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_args" class="level3">
<h3 class="anchored" data-anchor-id="mk_args">mk_args</h3>
<blockquote class="blockquote">
<pre><code> mk_args (args)</code></pre>
</blockquote>
<div id="e01eb416" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _convert_proto(o):</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert proto objects to Python dicts and lists"</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(o, (<span class="bu">dict</span>,MapComposite)): <span class="cf">return</span> {k:_convert_proto(v) <span class="cf">for</span> k,v <span class="kw">in</span> o.items()}</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(o, (<span class="bu">list</span>,RepeatedComposite)): <span class="cf">return</span> [_convert_proto(v) <span class="cf">for</span> v <span class="kw">in</span> o]</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(o, <span class="st">'DESCRIPTOR'</span>): <span class="cf">return</span> {k.name:_convert_proto(<span class="bu">getattr</span>(o,k.name)) <span class="cf">for</span> k <span class="kw">in</span> o.DESCRIPTOR.fields}</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> o</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="58bf1156" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_args(args):</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(args, MapComposite): <span class="cf">return</span> _convert_proto(args)</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {k: v <span class="cf">for</span> k,v <span class="kw">in</span> args.items()}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="708d8989" class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> mk_args(func.args)<span class="op">;</span> args</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'turns': [{'msg_b': 'Okay, here is a recipe:\\n\\nIngredients:\\n\\n1 cup (2 sticks) unsalted butter, softened\\n1 cup granulated sugar\\n1 cup packed brown sugar\\n2 teaspoons pure vanilla extract\\n2 large eggs\\n3 cups all-purpose flour\\n1 teaspoon baking soda\\n1 teaspoon salt\\n2 cups chocolate chips\\n\\nInstructions\\n\\nPreheat oven to 375 degrees F (190 degrees C). Line baking sheets with parchment paper.\\nIn a large bowl, cream together the butter, granulated sugar, and brown sugar until light and fluffy.\\nBeat in the vanilla extract, then the eggs one at a time.\\nIn a separate bowl, whisk together the flour, baking soda, and salt.\\nGradually add the dry ingredients to the wet ingredients, mixing until just combined.\\nStir in the chocolate chips.\\nDrop by rounded tablespoons onto the prepared baking sheets.\\nBake for 9-11 minutes, or until golden brown.Let cool on baking sheets for a few minutes before transferring to a wire rack to cool completely.',
   'msg_a': "Hey, I'd love a chocolate chip cookie recipe."}]}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L284" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_tool_config" class="level3">
<h3 class="anchored" data-anchor-id="mk_tool_config">mk_tool_config</h3>
<blockquote class="blockquote">
<pre><code> mk_tool_config (choose:list)</code></pre>
</blockquote>
<div id="0f31edf9" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tool_config(choose: <span class="bu">list</span>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"function_calling_config"</span>: {<span class="st">"mode"</span>: <span class="st">"ANY"</span>, <span class="st">"allowed_function_names"</span>:</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    [x.<span class="va">__name__</span> <span class="cf">if</span> <span class="bu">hasattr</span>(x, <span class="st">'__name__'</span>) <span class="cf">else</span> x.name <span class="cf">for</span> x <span class="kw">in</span> choose]}}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L291" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="client.structured" class="level3">
<h3 class="anchored" data-anchor-id="client.structured">Client.structured</h3>
<blockquote class="blockquote">
<pre><code> Client.structured (msgs:list, tools:list, sp:str=None, maxtok=4096,
                    stream:bool=False, generation_config:generation_types.
                    GenerationConfigType|None=None, safety_settings:safety
                    _types.SafetySettingOptions|None=None,
                    tool_config:content_types.ToolConfigType|None=None, re
                    quest_options:helper_types.RequestOptionsType|None=Non
                    e)</code></pre>
</blockquote>
<p><em>Return the value of all tool calls (generally used for structured outputs)</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>msgs</td>
<td>list</td>
<td></td>
<td>The prompt or list of prompts</td>
</tr>
<tr class="even">
<td>tools</td>
<td>list</td>
<td></td>
<td>Namespace to search for tools</td>
</tr>
<tr class="odd">
<td>sp</td>
<td>str</td>
<td>None</td>
<td>System prompt</td>
</tr>
<tr class="even">
<td>maxtok</td>
<td>int</td>
<td>4096</td>
<td>Maximum tokens</td>
</tr>
<tr class="odd">
<td>stream</td>
<td>bool</td>
<td>False</td>
<td>Stream response?</td>
</tr>
<tr class="even">
<td>generation_config</td>
<td>generation_types.GenerationConfigType | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>safety_settings</td>
<td>safety_types.SafetySettingOptions | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>tool_config</td>
<td>content_types.ToolConfigType | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>request_options</td>
<td>helper_types.RequestOptionsType | None</td>
<td>None</td>
<td></td>
</tr>
</tbody>
</table>
<div id="38f72d41" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(Client.<span class="fu">__call__</span>)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> structured(<span class="va">self</span>:Client,</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>               msgs:<span class="bu">list</span>, <span class="co"># The prompt or list of prompts</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>               tools:<span class="bu">list</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>               <span class="op">**</span>kwargs):</span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Return the value of all tool calls (generally used for structured outputs)"</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(msgs, <span class="bu">list</span>): msgs <span class="op">=</span> [msgs]</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(tools, <span class="bu">list</span>): tools <span class="op">=</span> [tools]</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>    kwargs[<span class="st">'tools'</span>] <span class="op">=</span> [cls2tool(x) <span class="cf">for</span> x <span class="kw">in</span> tools]</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>    kwargs[<span class="st">'tool_config'</span>] <span class="op">=</span> mk_tool_config(kwargs[<span class="st">'tools'</span>])</span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> <span class="va">self</span>(msgs, <span class="op">**</span>kwargs)</span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>    ns<span class="op">=</span>mk_ns(<span class="op">*</span>tools)</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> find_block(res).parts</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>    funcs <span class="op">=</span> [convert_func(p.function_call) <span class="cf">for</span> p <span class="kw">in</span> parts <span class="cf">if</span> <span class="bu">hasattr</span>(p, <span class="st">'function_call'</span>)]</span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>    tcs <span class="op">=</span> [call_func(func.name, func.inputs, ns<span class="op">=</span>ns) <span class="cf">for</span> func <span class="kw">in</span> funcs]</span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tcs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="090a499a" class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">"Create a conversation between Albert Einstein and Robert J. Oppenheimer"</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>convo <span class="op">=</span> c.structured(pr, tools<span class="op">=</span>[Conversation], sp<span class="op">=</span>sysp)[<span class="dv">0</span>]<span class="op">;</span> <span class="bu">print</span>(convo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Conversation(turns=[{'msg_b': 'Robert J. Oppenheimer: Indeed, Professor Einstein. Its mysteries both fascinate and, at times, trouble me. Especially those we are now starting to unravel with the atom.', 'msg_a': "Albert Einstein: The universe is a wondrous place, wouldn't you agree?"}, {'msg_b': "Robert J. Oppenheimer: Precisely. The potential for both creation and destruction weighs heavily on my mind. It's a double-edged sword.", 'msg_a': "Albert Einstein: Ah yes, the atom. A source of immense power, but also grave responsibility, wouldn't you say?"}, {'msg_b': 'Robert J. Oppenheimer: I concur. Yet, the forces of politics and conflict often seem to overshadow reason and progress. I fear our work might be used for ends we never intended.', 'msg_a': 'Albert Einstein: It is our duty, as scientists, to guide humanity toward the beneficial application of these discoveries, to prevent it from turning against itself.'}, {'msg_b': 'Robert J. Oppenheimer: I wish I had your certainty, Professor. The path ahead feels fraught with peril. Still, I am grateful for the pursuit of knowledge, even amidst the uncertainty.', 'msg_a': 'Albert Einstein: We must never lose hope that reason and understanding will prevail. The universe operates on elegant principles; if we remain dedicated to truth, we will find our way. '}, {'msg_b': 'Robert J. Oppenheimer: Perhaps, Professor. Perhaps.', 'msg_a': 'Albert Einstein: As am I, my friend. For it is through the exploration of these great mysteries that we glimpse the true nature of the universe and perhaps, our place within it.'}])</code></pre>
</div>
</div>
</section>
</section>
<section id="chat" class="level2">
<h2 class="anchored" data-anchor-id="chat">Chat</h2>
<p>We’ll create a Chat class that will handle formatting of messages and passing along system prompts and tools, so we don’t have to worry about doing that manually each time.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L308" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="chat-1" class="level3">
<h3 class="anchored" data-anchor-id="chat-1">Chat</h3>
<blockquote class="blockquote">
<pre><code> Chat (model:Optional[str]=None, cli:Optional[__main__.Client]=None,
       sp=None, tools:Optional[list]=None, tool_config:Optional[str]=None)</code></pre>
</blockquote>
<p><em>Gemini chat client.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>model</td>
<td>Optional</td>
<td>None</td>
<td>Model to use (leave empty if passing <code>cli</code>)</td>
</tr>
<tr class="even">
<td>cli</td>
<td>Optional</td>
<td>None</td>
<td>Client to use (leave empty if passing <code>model</code>)</td>
</tr>
<tr class="odd">
<td>sp</td>
<td>NoneType</td>
<td>None</td>
<td>Optional system prompt</td>
</tr>
<tr class="even">
<td>tools</td>
<td>Optional</td>
<td>None</td>
<td>List of tools to make available</td>
</tr>
<tr class="odd">
<td>tool_config</td>
<td>Optional</td>
<td>None</td>
<td>Forced tool choice</td>
</tr>
</tbody>
</table>
<div id="7740de24" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Chat:</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>                 model:Optional[<span class="bu">str</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># Model to use (leave empty if passing `cli`)</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>                 cli:Optional[Client]<span class="op">=</span><span class="va">None</span>, <span class="co"># Client to use (leave empty if passing `model`)</span></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>                 sp<span class="op">=</span><span class="va">None</span>, <span class="co"># Optional system prompt</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>                 tools:Optional[<span class="bu">list</span>]<span class="op">=</span><span class="va">None</span>,  <span class="co"># List of tools to make available</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>                 tool_config:Optional[<span class="bu">str</span>]<span class="op">=</span><span class="va">None</span>): <span class="co"># Forced tool choice</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Gemini chat client."</span></span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> model <span class="kw">or</span> cli</span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.c <span class="op">=</span> (cli <span class="kw">or</span> Client(model, sp<span class="op">=</span>sp))</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.h,<span class="va">self</span>.sp,<span class="va">self</span>.tools,<span class="va">self</span>.tool_config <span class="op">=</span> [],sp,tools,tool_config</span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> use(<span class="va">self</span>): <span class="cf">return</span> <span class="va">self</span>.c.use</span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cost(<span class="va">self</span>): <span class="cf">return</span> <span class="va">self</span>.c.cost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="4567fcf2" class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"Never mention what tools you use."</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp)</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>chat.use, chat.h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(In: 0; Out: 0; Total: 0, [])</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L350" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="chat.__call__" class="level3">
<h3 class="anchored" data-anchor-id="chat.__call__">Chat.__call__</h3>
<blockquote class="blockquote">
<pre><code> Chat.__call__ (pr=None, temp=0, maxtok=4096, stream=False,
                generation_config:generation_types.GenerationConfigType|No
                ne=None, safety_settings:safety_types.SafetySettingOptions
                |None=None,
                tools:content_types.FunctionLibraryType|None=None,
                tool_config:content_types.ToolConfigType|None=None,
                request_options:helper_types.RequestOptionsType|None=None)</code></pre>
</blockquote>
<p><em>Call self as a function.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pr</td>
<td>NoneType</td>
<td>None</td>
<td>Prompt / message</td>
</tr>
<tr class="even">
<td>temp</td>
<td>int</td>
<td>0</td>
<td>Temperature</td>
</tr>
<tr class="odd">
<td>maxtok</td>
<td>int</td>
<td>4096</td>
<td>Maximum tokens</td>
</tr>
<tr class="even">
<td>stream</td>
<td>bool</td>
<td>False</td>
<td>Stream response?</td>
</tr>
<tr class="odd">
<td>generation_config</td>
<td>generation_types.GenerationConfigType | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>safety_settings</td>
<td>safety_types.SafetySettingOptions | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>tools</td>
<td>content_types.FunctionLibraryType | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>tool_config</td>
<td>content_types.ToolConfigType | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>request_options</td>
<td>helper_types.RequestOptionsType | None</td>
<td>None</td>
<td></td>
</tr>
</tbody>
</table>
<div id="cbc4771f" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _stream(<span class="va">self</span>:Chat, res):</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> <span class="cf">from</span> res</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.h <span class="op">+=</span> mk_toolres(<span class="va">self</span>.c.result, ns<span class="op">=</span><span class="va">self</span>.tools)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="0aade98c" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _post_pr(<span class="va">self</span>:Chat, pr, prev_role):</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pr <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> prev_role <span class="op">==</span> <span class="st">'assistant'</span>:</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Prompt must be given after assistant completion, or use `self.cont_pr`."</span>)</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pr: <span class="va">self</span>.h.append(mk_msg(pr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="b3cc2c56" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _append_pr(<span class="va">self</span>:Chat,</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>               pr<span class="op">=</span><span class="va">None</span>,  <span class="co"># Prompt / message</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>              ):</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>    prev_role <span class="op">=</span> nested_idx(<span class="va">self</span>.h, <span class="op">-</span><span class="dv">1</span>, <span class="st">'role'</span>) <span class="cf">if</span> <span class="va">self</span>.h <span class="cf">else</span> <span class="st">'assistant'</span> <span class="co"># First message should be 'user'</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pr <span class="kw">and</span> prev_role <span class="op">==</span> <span class="st">'user'</span>: <span class="va">self</span>() <span class="co"># already user request pending</span></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._post_pr(pr, prev_role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="c23e3404" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(genai.GenerativeModel.generate_content)</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>:Chat,</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>             pr<span class="op">=</span><span class="va">None</span>,  <span class="co"># Prompt / message</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>             temp<span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>             maxtok<span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>             stream<span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>             <span class="op">**</span>kwargs):</span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(pr,<span class="bu">str</span>): pr <span class="op">=</span> pr.strip()</span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._append_pr(pr)</span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.tools: kwargs[<span class="st">'tools'</span>] <span class="op">=</span> <span class="va">self</span>.tools</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: Gemini specifies tool_choice via tool_config</span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.tool_config: kwargs[<span class="st">'tool_config'</span>] <span class="op">=</span> mk_tool_config(<span class="va">self</span>.tool_config)</span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> <span class="va">self</span>.c(<span class="va">self</span>.h, stream<span class="op">=</span>stream, sp<span class="op">=</span><span class="va">self</span>.sp, temp<span class="op">=</span>temp, maxtok<span class="op">=</span>maxtok, <span class="op">**</span>kwargs)</span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stream: <span class="cf">return</span> <span class="va">self</span>._stream(res)</span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.h <span class="op">+=</span> mk_toolres(<span class="va">self</span>.c.result, ns<span class="op">=</span><span class="va">self</span>.tools)</span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="778295e4" class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"I'm Faisal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>It’s nice to meet you, Faisal.</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: “It’s nice to meet you, Faisal.”}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.014608133922923695</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 12</li>
<li>candidates_token_count: 11</li>
<li>total_token_count: 23</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>Now let’s make sure that context is passed properly to subsequent calls</p>
<div id="df5374fa" class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"What's my name?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Faisal.</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘Your name is Faisal.’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -2.8847726449991267e-05</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 31</li>
<li>candidates_token_count: 6</li>
<li>total_token_count: 37</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>We can check our uage with the <code>use</code> property. As you can see it keeps track of the history of the conversation.</p>
<div id="3260680a" class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>chat.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 43; Out: 17; Total: 60</code></pre>
</div>
</div>
<p>Let’s make a nice markdown representation for our docs and jupyter notebooks of our chat object.</p>
<div id="f543a47c" class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _repr_markdown_(<span class="va">self</span>:Chat):</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>.c, <span class="st">'result'</span>): <span class="cf">return</span> <span class="st">'No results yet'</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>    last_msg <span class="op">=</span> contents(<span class="va">self</span>.c.result)</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(<span class="ss">f"**</span><span class="sc">{</span>m[<span class="st">'role'</span>]<span class="sc">}</span><span class="ss">**: </span><span class="sc">{</span>m[<span class="st">'parts'</span>][<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">isinstance</span>(m[<span class="st">'parts'</span>][<span class="dv">0</span>],<span class="bu">str</span>) <span class="cf">else</span> m[<span class="st">'parts'</span>][<span class="dv">0</span>]<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span> </span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">for</span> m <span class="kw">in</span> <span class="va">self</span>.h <span class="cf">if</span> m[<span class="st">'role'</span>] <span class="kw">in</span> (<span class="st">'user'</span>,<span class="st">'model'</span>))</span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>    det <span class="op">=</span> <span class="va">self</span>.c._repr_markdown_().split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""</span><span class="sc">{</span>last_msg<span class="sc">}</span></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;details&gt;</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;summary&gt;History&lt;/summary&gt;</span></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>history<span class="sc">}</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;/details&gt;</span></span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>det<span class="sc">}</span><span class="ss">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="651d3e57" class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>chat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Faisal.</p>
<details>
<summary>
History
</summary>
<p><strong>user</strong>: I’m Faisal</p>
<p><strong>model</strong>: It’s nice to meet you, Faisal.</p>
<p><strong>user</strong>: What’s my name?</p>
<p><strong>model</strong>: Your name is Faisal.</p>
</details>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th>Metric</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Cost (USD)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input tokens</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td>Output tokens</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="odd">
<td>Cache tokens</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td><strong>Total</strong></td>
<td style="text-align: right;"><strong>60</strong></td>
<td style="text-align: right;"><strong>$0.000000</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Let’s also make sure that streaming works correctly with the Chat interface</p>
<div id="ff26cbac" class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp)</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> chat(<span class="st">"I'm Faisal"</span>, stream<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>    o <span class="op">=</span> contents(o)</span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> o <span class="kw">and</span> <span class="bu">isinstance</span>(o, <span class="bu">str</span>): <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>It's nice to meet you, Faisal.</code></pre>
</div>
</div>
<p>Let’s also make sure that tool use works with the Chat interface</p>
<div id="e5a192f7" class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="ss">f"What is </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">+</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">?"</span><span class="op">;</span> pr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'What is 604542+6458932?'</code></pre>
</div>
</div>
<div id="27b3b278" class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"You are a helpful assistant. When using tools, be sure to pass all required parameters, at minimum."</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp, tools<span class="op">=</span>[sums])</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(<span class="st">"I'm Faisal"</span>)</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hello Faisal, how can I help you today?</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘Hello Faisal, how can I help you today?’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.03243409503589977</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 72</li>
<li>candidates_token_count: 11</li>
<li>total_token_count: 83</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<div id="18228faa" class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>chat(pr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542.0 and 6458932.0</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>function_call { name: “sums” args { fields { key: “b” value { number_value: 6458932 } } fields { key: “a” value { number_value: 604542 } } } }</p>
<details>
<ul>
<li>content: {‘parts’: [{‘function_call’: {‘name’: ‘sums’, ‘args’: {‘a’: 604542.0, ‘b’: 6458932.0}}}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -5.046702123460515e-06</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 103</li>
<li>candidates_token_count: 3</li>
<li>total_token_count: 106</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>The model correctly calls the right function in this case.</p>
<div id="4bf082b1" class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>chat.h[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'role': 'user',
 'parts': [name: "sums"
  response {
    fields {
      key: "result"
      value {
        number_value: 7063474
      }
    }
  }]}</code></pre>
</div>
</div>
<p>If we inspect the history, we can see that the result of the function call has already been added. We can simply call <code>chat()</code> to pass this to the model and get a response.</p>
<div id="ab1f61a9" class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>chat()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>7063474</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘7063474’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.10447429120540619</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 153</li>
<li>candidates_token_count: 8</li>
<li>total_token_count: 161</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>Now let’s make sure that <code>tool_config</code> works correctly by forcing the model to pick a particular function.</p>
<div id="cd5fe00f" class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> diff(</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>    a:<span class="bu">int</span>, <span class="co"># The number to subtract from</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>    b:<span class="bu">int</span> <span class="co"># The amount to subtract</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>: <span class="co"># Result of subtracting b from a</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns a - b."</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Finding the diff of </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">-</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7d7ef89c" class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"You are a helpful assistant. When using tools, be sure to pass all required parameters, at minimum."</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp, tools<span class="op">=</span>[sums, diff], tool_config<span class="op">=</span>[diff])</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(<span class="ss">f"What is </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">+</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">?"</span>)</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the diff of 604542.0 and -6458932.0</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>function_call { name: “diff” args { fields { key: “b” value { number_value: -6458932 } } fields { key: “a” value { number_value: 604542 } } } }</p>
<details>
<ul>
<li>content: {‘parts’: [{‘function_call’: {‘name’: ‘diff’, ‘args’: {‘a’: 604542.0, ‘b’: -6458932.0}}}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.005156605504453182</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 132</li>
<li>candidates_token_count: 3</li>
<li>total_token_count: 135</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>We can see that the model calls the function specified by <code>tool_config</code> even though the prompt asks for a summation, which is the expected behvior in this case.</p>
</section>
</section>
<section id="images" class="level2">
<h2 class="anchored" data-anchor-id="images">Images</h2>
<div id="3f6d787d" class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>fn <span class="op">=</span> Path(<span class="st">'./samples/puppy.jpg'</span>)</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>display.Image(filename<span class="op">=</span>fn, width<span class="op">=</span><span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-141-output-1.jpeg" class="img-fluid figure-img" width="200"></p>
</figure>
</div>
</div>
</div>
<p>Now that we are passing more than just text, will need a helper function to upload media using Gemini’s File API, which is the recomended way of passing media to the model.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L429" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="media_msg" class="level3">
<h3 class="anchored" data-anchor-id="media_msg">media_msg</h3>
<blockquote class="blockquote">
<pre><code> media_msg (fn:pathlib.Path)</code></pre>
</blockquote>
<div id="a0bb9a31" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> media_msg(fn: Path)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(fn, <span class="bu">dict</span>): <span class="cf">return</span> fn <span class="co"># Already processed</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> genai.upload_file(fn)</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'file_data'</span>: {<span class="st">'mime_type'</span>: f.mime_type, <span class="st">'file_uri'</span>: f.uri}}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s also update how we pass in text type messages, to be consistent</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L373" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="text_msg" class="level3">
<h3 class="anchored" data-anchor-id="text_msg">text_msg</h3>
<blockquote class="blockquote">
<pre><code> text_msg (s:str)</code></pre>
</blockquote>
<div id="87b0e3bd" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> text_msg(s:<span class="bu">str</span>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'text'</span>: s}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And finally lets add a helper function for make content correctly handles text and other media.</p>
<div id="ed657bae" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _mk_content(src):</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create appropriate content data structure based on type of content"</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(src,<span class="bu">str</span>): <span class="cf">return</span> text_msg(src)</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(src,FunctionResponse): <span class="cf">return</span> src</span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="cf">return</span> media_msg(src)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now let’s make sure it properly handles text vs.&nbsp;Path objects for media</p>
<div id="3befbdde" class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>_mk_content(<span class="st">"Hi"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'text': 'Hi'}</code></pre>
</div>
</div>
<div id="e50ad3ac" class="cell">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>_mk_content(fn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'file_data': {'mime_type': 'image/jpeg',
  'file_uri': 'https://generativelanguage.googleapis.com/v1beta/files/zpoa38voejtt'}}</code></pre>
</div>
</div>
<p>And now we need to update mk_msg to be able to handle multimedia messages correctly.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L384" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msg" class="level3">
<h3 class="anchored" data-anchor-id="mk_msg">mk_msg</h3>
<blockquote class="blockquote">
<pre><code> mk_msg (content, role='user', **kw)</code></pre>
</blockquote>
<div id="d1c0efc1" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msg(content, role<span class="op">=</span><span class="st">'user'</span>, <span class="op">**</span>kw):</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(content, GenerateContentResponse): role,content <span class="op">=</span> <span class="st">'model'</span>,contents(content)</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(content, <span class="bu">dict</span>): role,content <span class="op">=</span> content[<span class="st">'role'</span>],content[<span class="st">'parts'</span>]</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(content, <span class="bu">list</span>): content<span class="op">=</span>[content]</span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> role <span class="op">==</span> <span class="st">'user'</span>: </span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> content: <span class="co">## Gemini errors if the message contains only media and no text</span></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(content) <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> <span class="kw">not</span> <span class="bu">isinstance</span>(content[<span class="dv">0</span>], <span class="bu">str</span>): content.append(<span class="st">' '</span>)</span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>            content <span class="op">=</span> [_mk_content(o) <span class="cf">for</span> o <span class="kw">in</span> content]</span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: content <span class="op">=</span> <span class="st">''</span></span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(role<span class="op">=</span>role, parts<span class="op">=</span>content, <span class="op">**</span>kw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L396" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msgs-2" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs-2">mk_msgs</h3>
<blockquote class="blockquote">
<pre><code> mk_msgs (msgs:list, **kw)</code></pre>
</blockquote>
<p><em>Helper to set ‘assistant’ role on alternate messages.</em></p>
<div id="eb8f1b06" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msgs(msgs:<span class="bu">list</span>, <span class="op">**</span>kw):</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to set 'assistant' role on alternate messages."</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(msgs,<span class="bu">str</span>): msgs<span class="op">=</span>[msgs]</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [mk_msg(o, (<span class="st">'user'</span>,<span class="st">'model'</span>)[i<span class="op">%</span><span class="dv">2</span>], <span class="op">**</span>kw) <span class="cf">for</span> i,o <span class="kw">in</span> <span class="bu">enumerate</span>(msgs)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="abb995eb" class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> <span class="st">"In brief, what color flowers are in this image?"</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>mk_msgs([fn, q])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user',
  'parts': [{'file_data': {'mime_type': 'image/jpeg',
     'file_uri': 'https://generativelanguage.googleapis.com/v1beta/files/kmbr0020l5k6'}},
   {'text': ' '}]},
 {'role': 'model',
  'parts': ['In brief, what color flowers are in this image?']}]</code></pre>
</div>
</div>
<div id="8c742c12" class="cell">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>mk_msgs([<span class="st">'Hi'</span>, <span class="st">'Nice, to meet you. How can I help?'</span>, [fn, q]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'parts': [{'text': 'Hi'}]},
 {'role': 'model', 'parts': ['Nice, to meet you. How can I help?']},
 {'role': 'user',
  'parts': [{'file_data': {'mime_type': 'image/jpeg',
     'file_uri': 'https://generativelanguage.googleapis.com/v1beta/files/sfxeop0j911a'}},
   {'text': 'In brief, what color flowers are in this image?'}]}]</code></pre>
</div>
</div>
<p>Now, we should just be able to pass a list of multimedia content to our Chat client and it should be able to handle it all under the hood. Let’s test it out.</p>
<div id="4813f5fa-3e9a-4428-8368-ab23c02eed2c" class="cell">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>chat(fn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>This picture features an adorable Cavalier King Charles Spaniel puppy. It has beautiful brown and white fur, and is resting on a grassy area next to a patch of purple flowers. The puppy is looking directly at the camera with a sweet expression.</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘This picture features an adorable Cavalier King Charles Spaniel puppy. It has beautiful brown and white fur, and is resting on a grassy area next to a patch of purple flowers. The puppy is looking directly at the camera with a sweet expression.’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.6654894303302376</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 1183</li>
<li>candidates_token_count: 49</li>
<li>total_token_count: 1232</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<div id="061388df" class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>chat([fn, q])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The flowers in the image are purple.</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘The flowers in the image are purple.’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.011526683138476478</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 913</li>
<li>candidates_token_count: 9</li>
<li>total_token_count: 922</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>Hooray! That works, let’s double check the history to make sure that everything is properly formatted and stored.</p>
<div id="f13e5016" class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>mk_msgs(chat.h)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user',
  'parts': [{'file_data': {'mime_type': 'image/jpeg',
     'file_uri': 'https://generativelanguage.googleapis.com/v1beta/files/y1u2m1yaahq'}},
   {'text': ' '}]},
 {'role': 'model',
  'parts': ["This is an adorable image! The puppy is a Cavalier King Charles Spaniel with a beautiful coat of white and chestnut brown. It's nestled amongst some lovely purple flowers and green grass. The puppy's big, dark eyes and sweet expression make it irresistibly cute."]},
 {'role': 'user',
  'parts': [{'file_data': {'mime_type': 'image/jpeg',
     'file_uri': 'https://generativelanguage.googleapis.com/v1beta/files/xpvi2ey0087o'}},
   {'text': ' '}]},
 {'role': 'model',
  'parts': ['The image shows a charming Cavalier King Charles Spaniel puppy, with its distinctive white and chestnut coat, positioned amidst some blooming purple flowers. The pup is resting on the grass, and its gaze is directed towards the viewer. Its soft fur and gentle expression evoke a sense of warmth and tenderness.']},
 {'role': 'user',
  'parts': [{'file_data': {'mime_type': 'image/jpeg',
     'file_uri': 'https://generativelanguage.googleapis.com/v1beta/files/q2k4qztinipo'}},
   {'text': 'In brief, what color flowers are in this image?'}]},
 {'role': 'model', 'parts': ['The flowers in the image are purple.\n']}]</code></pre>
</div>
</div>
<p>While we are at it, let’s update our markdown representation to handle the new messages.</p>
<div id="7ec8987e" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _repr_markdown_(<span class="va">self</span>:Chat):</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(<span class="va">self</span>.c, <span class="st">'result'</span>): <span class="cf">return</span> <span class="st">'No results yet'</span></span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>    last_msg <span class="op">=</span> contents(<span class="va">self</span>.c.result)</span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fmt_part(ps):</span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(ps) <span class="op">==</span> <span class="dv">1</span>: <span class="cf">return</span> fmt_single(ps[<span class="dv">0</span>])</span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span> <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(<span class="ss">f'- </span><span class="sc">{</span>fmt_single(p)<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> p <span class="kw">in</span> ps)</span>
<span id="cb210-9"><a href="#cb210-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb210-10"><a href="#cb210-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fmt_single(p):</span>
<span id="cb210-11"><a href="#cb210-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'text'</span> <span class="kw">in</span> p: <span class="cf">return</span> p[<span class="st">'text'</span>]</span>
<span id="cb210-12"><a href="#cb210-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'file_data'</span> <span class="kw">in</span> p: <span class="cf">return</span> <span class="ss">f"uploaded media: </span><span class="sc">{</span>p[<span class="st">'file_data'</span>][<span class="st">'mime_type'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb210-13"><a href="#cb210-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">str</span>(p)</span>
<span id="cb210-14"><a href="#cb210-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb210-15"><a href="#cb210-15" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(<span class="ss">f"**</span><span class="sc">{</span>m[<span class="st">'role'</span>]<span class="sc">}</span><span class="ss">**: </span><span class="sc">{</span>fmt_part(m[<span class="st">'parts'</span>])<span class="sc">}</span><span class="ss">"</span> </span>
<span id="cb210-16"><a href="#cb210-16" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">for</span> m <span class="kw">in</span> <span class="va">self</span>.h <span class="cf">if</span> m[<span class="st">'role'</span>] <span class="kw">in</span> (<span class="st">'user'</span>,<span class="st">'model'</span>))</span>
<span id="cb210-17"><a href="#cb210-17" aria-hidden="true" tabindex="-1"></a>    det <span class="op">=</span> <span class="va">self</span>.c._repr_markdown_().split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb210-18"><a href="#cb210-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""</span><span class="sc">{</span>last_msg<span class="sc">}</span></span>
<span id="cb210-19"><a href="#cb210-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-20"><a href="#cb210-20" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;details&gt;</span></span>
<span id="cb210-21"><a href="#cb210-21" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;summary&gt;History&lt;/summary&gt;</span></span>
<span id="cb210-22"><a href="#cb210-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-23"><a href="#cb210-23" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>history<span class="sc">}</span></span>
<span id="cb210-24"><a href="#cb210-24" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;/details&gt;</span></span>
<span id="cb210-25"><a href="#cb210-25" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>det<span class="sc">}</span><span class="ss">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="67791706" class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>chat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>The flowers in the image are <strong>purple</strong>.</p>
<details>
<summary>
History
</summary>
<p><strong>user</strong>: - uploaded media: image/jpeg - In brief, what color flowers are in this image?</p>
<strong>model</strong>: The flowers in the image are <strong>purple</strong>.
</details>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th>Metric</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Cost (USD)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input tokens</td>
<td style="text-align: right;">270</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td>Output tokens</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="odd">
<td>Cache tokens</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td><strong>Total</strong></td>
<td style="text-align: right;"><strong>279</strong></td>
<td style="text-align: right;"><strong>$0.000000</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="other-media-audio-video-etc." class="level2">
<h2 class="anchored" data-anchor-id="other-media-audio-video-etc.">Other Media (audio, video, etc.)</h2>
<p>Unlike ChatGPT and Claude, Gemini models can also handle audio and video inputs. Since we’re using Gemini’s File API for handling multimedia content, what we have should just work, except we’ll need to make one small modification to the <a href="https://AnswerDotAI.github.io/gaspard/core.html#media_msg"><code>media_msg</code></a> function. Also, while we are at it, let us also allow for users to pass in the bytes of the content instead of the path to be consistent with our other LLM provider libraries.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/gaspard/blob/main/gaspard/core.py#L429" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="media_msg-1" class="level3">
<h3 class="anchored" data-anchor-id="media_msg-1">media_msg</h3>
<blockquote class="blockquote">
<pre><code> media_msg (media, mime=None)</code></pre>
</blockquote>
<p><em>Handle media input as either Path or bytes, returning dict for Gemini API</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>media</td>
<td></td>
<td></td>
<td>Media to process (Path|bytes|dict)</td>
</tr>
<tr class="even">
<td>mime</td>
<td>NoneType</td>
<td>None</td>
<td>Optional mime type</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>dict</strong></td>
<td></td>
<td><strong>Dict for Gemini API</strong></td>
</tr>
</tbody>
</table>
<div id="47e4d9f5" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> media_msg(</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>    media, <span class="co"># Media to process (Path|bytes|dict)</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>    mime<span class="op">=</span><span class="va">None</span> <span class="co"># Optional mime type</span></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">dict</span>: <span class="co"># Dict for Gemini API</span></span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Handle media input as either Path or bytes, returning dict for Gemini API"</span></span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(media, <span class="bu">dict</span>): <span class="cf">return</span> media <span class="co"># Already processed</span></span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _upload(f, mime<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a>        f <span class="op">=</span> genai.upload_file(f, mime_type<span class="op">=</span>mime)</span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> f.state.name <span class="op">==</span> <span class="st">"PROCESSING"</span>: time.sleep(<span class="dv">2</span>)<span class="op">;</span> f <span class="op">=</span> genai.get_file(f.name)</span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'file_data'</span>: {<span class="st">'mime_type'</span>: f.mime_type, <span class="st">'file_uri'</span>: f.uri}}</span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(media, (<span class="bu">str</span>,Path)): <span class="cf">return</span> _upload(media)</span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(media, <span class="bu">bytes</span>) <span class="kw">and</span> mime <span class="kw">is</span> <span class="va">None</span>: mime <span class="op">=</span> ft.guess(media).mime</span>
<span id="cb213-13"><a href="#cb213-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _upload(io.BytesIO(media <span class="cf">if</span> <span class="bu">isinstance</span>(media, <span class="bu">bytes</span>) <span class="cf">else</span> media.encode()), mime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Since we’re uploading potentially larger files, we need to wait for the upload and process to complete so that the media is ready to be consumed by the model.</p>
<div id="06916192" class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model)</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> fn.read_bytes()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d89e459b" class="cell">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>chat([img, q])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
Certainly! The flowers in the image are a light purple color.
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘Certainly! The flowers in the image are a light purple color.’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.45572607333843523</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 270</li>
<li>candidates_token_count: 13</li>
<li>total_token_count: 283</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<div id="dc822d82" class="cell">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll test this with the example from Gemini's docs</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>video_fn <span class="op">=</span> Path(<span class="st">'./samples/selective_attention_test.mp4'</span>)</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"Answer the question in the video"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="369c0710" class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model)</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>chat([video_fn, prompt])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
The players wearing white pass the basketball 13 times.
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘The players wearing white pass the basketball 13 times.’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.4509180386861165</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 10527</li>
<li>candidates_token_count: 12</li>
<li>total_token_count: 10539</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>Takes a little while, but works like a charm! Now, let’s try an audio file to make sure it also works.</p>
<div id="770ae3b4" class="cell">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>audio_fn <span class="op">=</span> Path(<span class="st">'./samples/attention_is_all_you_need.mp3'</span>)</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>audio <span class="op">=</span> audio_fn.read_bytes()</span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"What is the audio about?"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="03856f04" class="cell">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>chat([audio, prompt])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
The audio is a podcast discussion about a groundbreaking research paper titled “Attention is All You Need” by Vaswani et al.&nbsp;The podcast features a machine learning expert who explains the core ideas, motivation, and architecture of the Transformer model introduced in the paper. They discuss the significance of attention mechanisms, how the Transformer differs from previous approaches like RNNs, its remarkable performance on machine translation and other sequence transduction tasks, and the broader implications of the research for machine learning and NLP. They also touch upon the limitations and future directions.
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘The audio is a podcast discussion about a groundbreaking research paper titled “Attention is All You Need” by Vaswani et al.&nbsp;The podcast features a machine learning expert who explains the core ideas, motivation, and architecture of the Transformer model introduced in the paper. They discuss the significance of attention mechanisms, how the Transformer differs from previous approaches like RNNs, its remarkable performance on machine translation and other sequence transduction tasks, and the broader implications of the research for machine learning and NLP. They also touch upon the limitations and future directions.’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.48403912498837426</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 18387</li>
<li>candidates_token_count: 105</li>
<li>total_token_count: 18492</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>Finally, let’s check to make sure pdfs work as well.</p>
<div id="ad4a8110" class="cell">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>pdf_fn <span class="op">=</span> Path(<span class="st">'./samples/attention_is_all_you_need.pdf'</span>)</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"What's mentioned in this pdf that's not mentioned in the previous podcast?"</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>chat([pdf_fn, prompt])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Okay, here’s a breakdown of what’s in the PDF that wasn’t covered in the podcast:</p>
<p><strong>Technical Details of the Transformer:</strong></p>
<ul>
<li><p><strong>Detailed Architecture:</strong> The PDF provides a much more detailed breakdown of the Transformer architecture, including the specific arrangement of encoder and decoder layers, sub-layers, residual connections, and layer normalization (see Figure 1 and Section 3.1). The podcast gave a high-level overview, whereas the PDF is more specific about the components used to build the model.</p></li>
<li><p><strong>Scaled Dot-Product Attention:</strong> The document explains the mechanics of “Scaled Dot-Product Attention” (section 3.2.1, Figure 2), and its advantages over additive attention and specifically mentions that dot products are scaled by <code>1/sqrt(dk)</code>. This isn’t mentioned in the podcast.</p></li>
<li><p><strong>Multi-Head Attention:</strong> The PDF delves into the purpose of “Multi-Head Attention”, stating that it enables the model to attend to different representation subspaces (section 3.2.2, Figure 2). It also explicitly states that the projections are parameter matrices such as <code>WQ ∈ R^(d_model x d_k), WK ∈ R^(d_model x d_k)</code>, etc.. and gives the values for the number of attention layers used. The podcast explained what multi-head attention was, but didn’t delve into the math or specific values used.</p></li>
<li><p><strong>Positional Encodings:</strong> The PDF describes the specific sine and cosine functions used for positional encoding (section 3.5) and why they chose this method. This level of detail about this topic isn’t mentioned in the podcast.</p></li>
<li><p><strong>Point-wise Feed-Forward Networks:</strong> The podcast doesn’t go into the details of this topic, but the PDF notes that feed-forward networks in each layer are position-wise, fully connected, and consist of two linear transformations with a ReLU activation in between. It also specifies the dimensionality of input and output as well as the inner layer (section 3.3).</p></li>
<li><p><strong>Embeddings and Softmax:</strong> The PDF states how learned embeddings are used to convert input/output tokens to vectors (section 3.4), and that the same weight matrix is shared between embeddings and the pre-softmax linear transformation. The embeddings are multiplied by the square root of d_model. These details are not mentioned in the podcast.</p></li>
</ul>
<p><strong>Training and Evaluation:</strong></p>
<ul>
<li><strong>Training Details:</strong> The PDF explains the datasets (WMT 2014 English-German and English-French), the use of byte-pair encoding and word-piece vocabularies, and batching based on approximate sequence lengths (section 5.1). It also specifies how the model is trained using a specific number of training steps, using GPUs, the Adam optimizer and a specific formula for varying the learning rate (sections 5.2, 5.3). The podcast briefly mentions training time, but doesn’t give specific dataset, architecture, or learning details.</li>
<li><strong>Regularization:</strong> The PDF explicitly mentions the use of residual dropout and label smoothing during training and the parameters used (section 5.4). The podcast didn’t discuss this at all.</li>
<li><strong>Performance Metrics:</strong> The PDF presents specific BLEU scores for various models on the English-German and English-French translation tasks and lists the training cost in FLOPS (section 6.1, Table 2). It also mentions beam search details like beam size and a length penalty. The podcast only mentions the end results of BLEU score.</li>
<li><strong>Model Variations:</strong> The PDF explores various variations of the base model (section 6.2, Table 3), testing different parameters (number of heads, key/value dimensions, dropout rates, etc.), and mentions which variations performed well or poorly. The podcast doesn’t mention any of these experiments.</li>
<li><strong>English Constituency Parsing Results:</strong> The PDF mentions that the transformer performs well on english constituency parsing with results from the Penn Treebank (section 6.3, Table 4) and compares its results against other models. This is only briefly touched on in the podcast, and none of the results from this section is covered.</li>
</ul>
<p><strong>Other Points</strong></p>
<ul>
<li><strong>Computational Complexity Analysis:</strong> The PDF includes a table (Table 1) that compares the computational complexity, sequential operations and maximum path lengths of self-attention, recurrent and convolutional layers. This is not covered in the podcast.</li>
<li><strong>Attention Visualizations:</strong> The PDF includes visualization examples of attention heads for certain words (Figure 3, 4, and 5), showcasing the behavior and long range dependencies. These visualizations are not shown nor covered in the podcast.</li>
<li><strong>References and Acknowledgements:</strong> The document has a complete list of references and acknowledgements. This was not part of the podcast.</li>
</ul>
<p><strong>In summary, while the podcast provided a good overview, the PDF offers a deeper technical dive into the Transformer model, along with details about its training, experiments, and evaluations that aren’t touched upon in the audio discussion.</strong> The PDF provides specifics that an audience interested in implementing the model or performing experiments would be interested in.</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ’Okay, here's a breakdown of what's in the PDF that wasn't covered in the podcast:*Technical Details of the Transformer:<strong></strong>Detailed Architecture:<strong> The PDF provides a much more detailed breakdown of the Transformer architecture, including the specific arrangement of encoder and decoder layers, sub-layers, residual connections, and layer normalization (see Figure 1 and Section 3.1). The podcast gave a high-level overview, whereas the PDF is more specific about the components used to build the model.</strong>Scaled Dot-Product Attention:<strong> The document explains the mechanics of “Scaled Dot-Product Attention” (section 3.2.1, Figure 2), and its advantages over additive attention and specifically mentions that dot products are scaled by <code>1/sqrt(dk)</code>. This isn't mentioned in the podcast.</strong>Multi-Head Attention:<strong> The PDF delves into the purpose of “Multi-Head Attention”, stating that it enables the model to attend to different representation subspaces (section 3.2.2, Figure 2). It also explicitly states that the projections are parameter matrices such as <code>WQ ∈ R^(d_model x d_k), WK ∈ R^(d_model x d_k)</code>, etc.. and gives the values for the number of attention layers used. The podcast explained what multi-head attention was, but didn't delve into the math or specific values used.</strong>Positional Encodings:<strong> The PDF describes the specific sine and cosine functions used for positional encoding (section 3.5) and why they chose this method. This level of detail about this topic isn't mentioned in the podcast.</strong>Point-wise Feed-Forward Networks:<strong> The podcast doesn't go into the details of this topic, but the PDF notes that feed-forward networks in each layer are position-wise, fully connected, and consist of two linear transformations with a ReLU activation in between. It also specifies the dimensionality of input and output as well as the inner layer (section 3.3).</strong>Embeddings and Softmax:** The PDF states how learned embeddings are used to convert input/output tokens to vectors (section 3.4), and that the same weight matrix is shared between embeddings and the pre-softmax linear transformation. The embeddings are multiplied by the square root of d_model. These details are not mentioned in the podcast.*Training and Evaluation:<strong></strong>Training Details:<strong> The PDF explains the datasets (WMT 2014 English-German and English-French), the use of byte-pair encoding and word-piece vocabularies, and batching based on approximate sequence lengths (section 5.1). It also specifies how the model is trained using a specific number of training steps, using GPUs, the Adam optimizer and a specific formula for varying the learning rate (sections 5.2, 5.3). The podcast briefly mentions training time, but doesn't give specific dataset, architecture, or learning details.</strong>Regularization:<strong> The PDF explicitly mentions the use of residual dropout and label smoothing during training and the parameters used (section 5.4). The podcast didn't discuss this at all.</strong>Performance Metrics:<strong> The PDF presents specific BLEU scores for various models on the English-German and English-French translation tasks and lists the training cost in FLOPS (section 6.1, Table 2). It also mentions beam search details like beam size and a length penalty. The podcast only mentions the end results of BLEU score.</strong>Model Variations:<strong> The PDF explores various variations of the base model (section 6.2, Table 3), testing different parameters (number of heads, key/value dimensions, dropout rates, etc.), and mentions which variations performed well or poorly. The podcast doesn't mention any of these experiments.</strong>English Constituency Parsing Results:** The PDF mentions that the transformer performs well on english constituency parsing with results from the Penn Treebank (section 6.3, Table 4) and compares its results against other models. This is only briefly touched on in the podcast, and none of the results from this section is covered.*Other Points<strong></strong>Computational Complexity Analysis:<strong> The PDF includes a table (Table 1) that compares the computational complexity, sequential operations and maximum path lengths of self-attention, recurrent and convolutional layers. This is not covered in the podcast.</strong>Attention Visualizations:<strong> The PDF includes visualization examples of attention heads for certain words (Figure 3, 4, and 5), showcasing the behavior and long range dependencies. These visualizations are not shown nor covered in the podcast.</strong>References and Acknowledgements:** The document has a complete list of references and acknowledgements. This was not part of the podcast.*In summary, while the podcast provided a good overview, the PDF offers a deeper technical dive into the Transformer model, along with details about its training, experiments, and evaluations that aren't touched upon in the audio discussion.** The PDF provides specifics that an audience interested in implementing the model or performing experiments would be interested in.’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.8560131542336379</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 33441</li>
<li>candidates_token_count: 1081</li>
<li>total_token_count: 34522</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<p>Gemini does a pretty good job here!!</p>
<div id="841ad692" class="cell">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">"Can you generate an exact transcript of the first minute or so of the podcast."</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>chat(pr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Okay, here’s the transcript of the first minute of the podcast, based on your request:</p>
<p>“Welcome to our podcast, where we dive into groundbreaking research papers. Today, we’re discussing ‘Attention is All You Need’ by Vaswani et al.&nbsp;Joining us is an expert in machine learning. Welcome. Thanks for having me. I’m excited to discuss this revolutionary paper. Let’s start with the core idea. What’s the main thrust of this research? The paper introduces a new model architecture called the Transformer, which is based entirely on attention mechanisms. It completely does away with recurrence and convolutions, which were staples in previous sequence transduction models. That sounds like a significant departure from previous approaches. What motivated this radical change? The main motivation was to address limitations in previous models, particularly the sequential nature of processing in RNNs. This sequential computation hindered parallelization and made it challenging to learn long-range dependencies in sequences. Could you explain what attention mechanisms are and why they’re so crucial in this model? Certainly. Attention allows the model to focus on different parts of the input sequence when producing each part of the output. In the Transformer, they use a specific type called scaled dot product attention and extend it to multi head attention, which lets the model jointly attend to information from different representation sub spaces. Fascinating.”</p>
<details>
<ul>
<li>content: {‘parts’: [{‘text’: ‘Okay, here's the transcript of the first minute of the podcast, based on your request:“Welcome to our podcast, where we dive into groundbreaking research papers. Today, we're discussing 'Attention is All You Need' by Vaswani et al.&nbsp;Joining us is an expert in machine learning. Welcome. Thanks for having me. I'm excited to discuss this revolutionary paper. Let's start with the core idea. What's the main thrust of this research? The paper introduces a new model architecture called the Transformer, which is based entirely on attention mechanisms. It completely does away with recurrence and convolutions, which were staples in previous sequence transduction models. That sounds like a significant departure from previous approaches. What motivated this radical change? The main motivation was to address limitations in previous models, particularly the sequential nature of processing in RNNs. This sequential computation hindered parallelization and made it challenging to learn long-range dependencies in sequences. Could you explain what attention mechanisms are and why they're so crucial in this model? Certainly. Attention allows the model to focus on different parts of the input sequence when producing each part of the output. In the Transformer, they use a specific type called scaled dot product attention and extend it to multi head attention, which lets the model jointly attend to information from different representation sub spaces. Fascinating.”’}], ‘role’: ‘model’}</li>
<li>finish_reason: 1</li>
<li>safety_ratings: [{‘category’: 8, ‘probability’: 1, ‘blocked’: False}, {‘category’: 10, ‘probability’: 1, ‘blocked’: False}, {‘category’: 7, ‘probability’: 1, ‘blocked’: False}, {‘category’: 9, ‘probability’: 1, ‘blocked’: False}]</li>
<li>avg_logprobs: -0.07141794775524278</li>
<li>token_count: 0</li>
<li>grounding_attributions: []</li>
<li>prompt_token_count: 34540</li>
<li>candidates_token_count: 274</li>
<li>total_token_count: 34814</li>
<li>cached_content_token_count: 0</li>
</ul>
</details>
</div>
</div>
<div id="c515180d" class="cell">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a>chat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Okay, here’s the transcript of the first minute of the podcast, based on your request:</p>
<p>“Welcome to our podcast, where we dive into groundbreaking research papers. Today, we’re discussing ‘Attention is All You Need’ by Vaswani et al.&nbsp;Joining us is an expert in machine learning. Welcome. Thanks for having me. I’m excited to discuss this revolutionary paper. Let’s start with the core idea. What’s the main thrust of this research? The paper introduces a new model architecture called the Transformer, which is based entirely on attention mechanisms. It completely does away with recurrence and convolutions, which were staples in previous sequence transduction models. That sounds like a significant departure from previous approaches. What motivated this radical change? The main motivation was to address limitations in previous models, particularly the sequential nature of processing in RNNs. This sequential computation hindered parallelization and made it challenging to learn long-range dependencies in sequences. Could you explain what attention mechanisms are and why they’re so crucial in this model? Certainly. Attention allows the model to focus on different parts of the input sequence when producing each part of the output. In the Transformer, they use a specific type called scaled dot product attention and extend it to multi head attention, which lets the model jointly attend to information from different representation sub spaces. Fascinating.”</p>
<details>
<summary>
History
</summary>
<p><strong>user</strong>: - uploaded media: video/mp4 - Answer the question in the video</p>
<p><strong>model</strong>: The players wearing white pass the basketball 13 times.</p>
<p><strong>user</strong>: - uploaded media: audio/mpeg - What is the audio about?</p>
<p><strong>model</strong>: The audio is a podcast discussion about a groundbreaking research paper titled “Attention is All You Need” by Vaswani et al.&nbsp;The podcast features a machine learning expert who explains the core ideas, motivation, and architecture of the Transformer model introduced in the paper. They discuss the significance of attention mechanisms, how the Transformer differs from previous approaches like RNNs, its remarkable performance on machine translation and other sequence transduction tasks, and the broader implications of the research for machine learning and NLP. They also touch upon the limitations and future directions.</p>
<p><strong>user</strong>: - uploaded media: application/pdf - What’s mentioned in this pdf that’s not mentioned in the previous podcast?</p>
<p><strong>model</strong>: Okay, here’s a breakdown of what’s in the PDF that wasn’t covered in the podcast:</p>
<p><strong>Technical Details of the Transformer:</strong></p>
<ul>
<li><p><strong>Detailed Architecture:</strong> The PDF provides a much more detailed breakdown of the Transformer architecture, including the specific arrangement of encoder and decoder layers, sub-layers, residual connections, and layer normalization (see Figure 1 and Section 3.1). The podcast gave a high-level overview, whereas the PDF is more specific about the components used to build the model.</p></li>
<li><p><strong>Scaled Dot-Product Attention:</strong> The document explains the mechanics of “Scaled Dot-Product Attention” (section 3.2.1, Figure 2), and its advantages over additive attention and specifically mentions that dot products are scaled by <code>1/sqrt(dk)</code>. This isn’t mentioned in the podcast.</p></li>
<li><p><strong>Multi-Head Attention:</strong> The PDF delves into the purpose of “Multi-Head Attention”, stating that it enables the model to attend to different representation subspaces (section 3.2.2, Figure 2). It also explicitly states that the projections are parameter matrices such as <code>WQ ∈ R^(d_model x d_k), WK ∈ R^(d_model x d_k)</code>, etc.. and gives the values for the number of attention layers used. The podcast explained what multi-head attention was, but didn’t delve into the math or specific values used.</p></li>
<li><p><strong>Positional Encodings:</strong> The PDF describes the specific sine and cosine functions used for positional encoding (section 3.5) and why they chose this method. This level of detail about this topic isn’t mentioned in the podcast.</p></li>
<li><p><strong>Point-wise Feed-Forward Networks:</strong> The podcast doesn’t go into the details of this topic, but the PDF notes that feed-forward networks in each layer are position-wise, fully connected, and consist of two linear transformations with a ReLU activation in between. It also specifies the dimensionality of input and output as well as the inner layer (section 3.3).</p></li>
<li><p><strong>Embeddings and Softmax:</strong> The PDF states how learned embeddings are used to convert input/output tokens to vectors (section 3.4), and that the same weight matrix is shared between embeddings and the pre-softmax linear transformation. The embeddings are multiplied by the square root of d_model. These details are not mentioned in the podcast.</p></li>
</ul>
<p><strong>Training and Evaluation:</strong></p>
<ul>
<li><strong>Training Details:</strong> The PDF explains the datasets (WMT 2014 English-German and English-French), the use of byte-pair encoding and word-piece vocabularies, and batching based on approximate sequence lengths (section 5.1). It also specifies how the model is trained using a specific number of training steps, using GPUs, the Adam optimizer and a specific formula for varying the learning rate (sections 5.2, 5.3). The podcast briefly mentions training time, but doesn’t give specific dataset, architecture, or learning details.</li>
<li><strong>Regularization:</strong> The PDF explicitly mentions the use of residual dropout and label smoothing during training and the parameters used (section 5.4). The podcast didn’t discuss this at all.</li>
<li><strong>Performance Metrics:</strong> The PDF presents specific BLEU scores for various models on the English-German and English-French translation tasks and lists the training cost in FLOPS (section 6.1, Table 2). It also mentions beam search details like beam size and a length penalty. The podcast only mentions the end results of BLEU score.</li>
<li><strong>Model Variations:</strong> The PDF explores various variations of the base model (section 6.2, Table 3), testing different parameters (number of heads, key/value dimensions, dropout rates, etc.), and mentions which variations performed well or poorly. The podcast doesn’t mention any of these experiments.</li>
<li><strong>English Constituency Parsing Results:</strong> The PDF mentions that the transformer performs well on english constituency parsing with results from the Penn Treebank (section 6.3, Table 4) and compares its results against other models. This is only briefly touched on in the podcast, and none of the results from this section is covered.</li>
</ul>
<p><strong>Other Points</strong></p>
<ul>
<li><strong>Computational Complexity Analysis:</strong> The PDF includes a table (Table 1) that compares the computational complexity, sequential operations and maximum path lengths of self-attention, recurrent and convolutional layers. This is not covered in the podcast.</li>
<li><strong>Attention Visualizations:</strong> The PDF includes visualization examples of attention heads for certain words (Figure 3, 4, and 5), showcasing the behavior and long range dependencies. These visualizations are not shown nor covered in the podcast.</li>
<li><strong>References and Acknowledgements:</strong> The document has a complete list of references and acknowledgements. This was not part of the podcast.</li>
</ul>
<p><strong>In summary, while the podcast provided a good overview, the PDF offers a deeper technical dive into the Transformer model, along with details about its training, experiments, and evaluations that aren’t touched upon in the audio discussion.</strong> The PDF provides specifics that an audience interested in implementing the model or performing experiments would be interested in.</p>
<p><strong>user</strong>: Can you generate an exact transcript of the first minute or so of the podcast.</p>
<p><strong>model</strong>: Okay, here’s the transcript of the first minute of the podcast, based on your request:</p>
<p>“Welcome to our podcast, where we dive into groundbreaking research papers. Today, we’re discussing ‘Attention is All You Need’ by Vaswani et al.&nbsp;Joining us is an expert in machine learning. Welcome. Thanks for having me. I’m excited to discuss this revolutionary paper. Let’s start with the core idea. What’s the main thrust of this research? The paper introduces a new model architecture called the Transformer, which is based entirely on attention mechanisms. It completely does away with recurrence and convolutions, which were staples in previous sequence transduction models. That sounds like a significant departure from previous approaches. What motivated this radical change? The main motivation was to address limitations in previous models, particularly the sequential nature of processing in RNNs. This sequential computation hindered parallelization and made it challenging to learn long-range dependencies in sequences. Could you explain what attention mechanisms are and why they’re so crucial in this model? Certainly. Attention allows the model to focus on different parts of the input sequence when producing each part of the output. In the Transformer, they use a specific type called scaled dot product attention and extend it to multi head attention, which lets the model jointly attend to information from different representation sub spaces. Fascinating.”</p>
</details>
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th>Metric</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Cost (USD)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input tokens</td>
<td style="text-align: right;">96,895</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td>Output tokens</td>
<td style="text-align: right;">1,472</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="odd">
<td>Cache tokens</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td><strong>Total</strong></td>
<td style="text-align: right;"><strong>98,367</strong></td>
<td style="text-align: right;"><strong>$0.000000</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>All of these also work with <a href="https://AnswerDotAI.github.io/gaspard/core.html#client"><code>Client</code></a> and can be combined with <code>structured</code> to get structured responses using multi-media data.</p>
<div id="6e29f43a" class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AudioMetadata(BasicRepr):</span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Class to hold metadata for audio files"""</span></span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>        n_speakers:<span class="bu">int</span>, <span class="co"># Number of speakers</span></span>
<span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a>        topic:<span class="bu">str</span>, <span class="co"># Topic discussed</span></span>
<span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a>        summary:<span class="bu">str</span>, <span class="co"># 100 word summary</span></span>
<span id="cb223-8"><a href="#cb223-8" aria-hidden="true" tabindex="-1"></a>        transcript:<span class="bu">list</span>[<span class="bu">str</span>], <span class="co"># Transcript of the audio segmented by speaker</span></span>
<span id="cb223-9"><a href="#cb223-9" aria-hidden="true" tabindex="-1"></a>    ): store_attr()</span>
<span id="cb223-10"><a href="#cb223-10" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="st">"Extract the necessary information from the audio."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f41e2b43" class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Client(model)</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>audio_md <span class="op">=</span> c.structured(mk_msgs([[audio_fn, pr]]), tools<span class="op">=</span>[AudioMetadata])[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a9bcb6ec" class="cell">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Number of speakers: </span><span class="sc">{</span>audio_md<span class="sc">.</span>n_speakers<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Topic: </span><span class="sc">{</span>audio_md<span class="sc">.</span>topic<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Summary: </span><span class="sc">{</span>audio_md<span class="sc">.</span>summary<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>transcript <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">-'</span>.join(<span class="bu">list</span>(audio_md.transcript)[:<span class="dv">10</span>])</span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Transcript: </span><span class="sc">{</span>transcript<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of speakers: 2.0
Topic: Machine Learning, Natural Language Processing
Summary: This podcast discusses the Attention is All You Need research paper, focusing on the Transformer model's architecture, attention mechanisms, performance, and broader implications.
Transcript: Welcome to our podcast, where we dive into groundbreaking research papers. Today, we're discussing attention is all you need by Vaswani at all. Joining us is an expert in machine learning. Welcome.
-Thanks for having me. I'm excited to discuss this revolutionary paper.
-Let's start with the core idea. What's the main thrust of this research?
-The paper introduces a new model architecture called the Transformer, which is based entirely on attention mechanisms. It completely does away with recurrence and convolutions, which were staples in previous sequence transduction models.
-That sounds like a significant departure from previous approaches. What motivated this radical change?
-The main motivation was to address limitations in previous models, particularly the sequential nature of processing in RNNs. This sequential computation hindered parallelization and made it challenging to learn long-range dependencies in sequences.
-Could you explain what attention mechanisms are and why they're so crucial in this model?
-Certainly. Attention allows the model to focus on different parts of the input sequence when producing each part of the output. In the Transformer, they use a specific type called scaled dot-product attention and extend it to multi-head attention, which lets the model jointly attend to information from different representation sub-spaces.
-Fascinating. How does the Transformer's architecture differ from previous models?
-The Transformer uses a stack of identical layers for both the encoder and decoder. Each layer has two main components: a multi-head self-attention mechanism and a position-wise fully connected feed-forward network. This structure allows for more parallelization and efficient computation.</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/AnswerDotAI\.github\.io\/gaspard");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/AnswerDotAI/gaspard/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>